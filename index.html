<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resinelli Monitor</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Google API Client (Gmail) -->
  <script src="https://apis.google.com/js/api.js" async defer></script>

  <style>
    :root{ --bg1:#0b1220; --bg2:#0f1a2c; --acc:#93c5fd; --acc2:#22d3ee; --live-h:75svh }
    html,body{ height:100% }
    body{
      background:
        radial-gradient(1000px 520px at 15% -10%, rgba(147,197,253,.15), transparent),
        radial-gradient(900px 520px at 100% 0%, rgba(34,211,238,.12), transparent),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      color:#e5e7eb;
    }
    .glass{ background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
            backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,.08) }
    .brand-grad{ background:linear-gradient(90deg,var(--acc),var(--acc2)); }
    .stream-outer{ display:grid; grid-template-rows:auto 1fr; gap:.75rem; padding-bottom:.5rem; overflow:visible }
    .stream-box{ position:relative; width:100%; aspect-ratio:9/16; max-height:var(--live-h,75svh); background:#000; border:1px solid rgba(255,255,255,.1); border-radius:14px; overflow:hidden }
    .stream-media, .stream-frame{ width:100%; height:100%; object-fit:contain; background:#000; border:0 }
    .scanbar{ position:relative; overflow:hidden }
    .scanbar::after{ content:""; position:absolute; inset:0; background:linear-gradient(90deg,transparent,rgba(255,255,255,.15),transparent); transform:translateX(-100%); animation:scan 2.2s infinite }
    @keyframes scan{ 0%{transform:translateX(-100%)} 60%{transform:translateX(100%)} 100%{transform:translateX(100%)} }
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:50 }
    .overlay.show{ display:flex }
    #rowModalBody{ background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02)); border-radius:18px; box-shadow:0 2px 32px #0008; padding:2rem; min-width:320px; max-width:96vw; color:#e2e8f0 }
    .tab-btn{ border-bottom:2px solid transparent }
    .tab-btn.active{ color:#fff; border-color:var(--acc2) }
    .badge{ display:inline-flex; align-items:center; gap:.4rem; font-size:.75rem; padding:.2rem .5rem; border-radius:.5rem; border:1px solid transparent }

    .live-toolbar{ position:absolute; inset:0 0 auto 0; height:40px; display:flex; gap:.5rem; align-items:center; padding:.25rem .5rem; background:rgba(2,6,23,.65); z-index:2; }
    #statusBox{ position:absolute; left:0; right:0; top:42px; z-index:2; }
    .min-h-5{ min-height:1.25rem }
  </style>
</head>
<body>
  <!-- TOP BAR -->
  <header class="glass sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded-lg brand-grad"></div>
          <div>
            <div class="text-lg font-semibold tracking-wide">Resinelli Monitor</div>
            <div class="text-[12px] text-slate-400 -mt-0.5">Celle frigo · live & storico</div>
          </div>
        </div>
        <nav class="flex items-center gap-4">
          <button data-route="#home" class="tab-btn route-btn px-1 py-2 text-slate-300 hover:text-white">Home</button>
          <button data-route="#storico" class="tab-btn route-btn px-1 py-2 text-slate-300 hover:text-white">Storico</button>
          <button data-route="#impostazioni" class="tab-btn route-btn px-1 py-2 text-slate-300 hover:text-white">Impostazioni</button>
        </nav>
        <div class="flex items-center gap-2">
          <button id="btnAdvanced" class="px-2 py-2 rounded-lg bg-slate-800 hover:bg-slate-700" title="Impostazioni avanzate" aria-label="Impostazioni avanzate">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="1.5" d="M12 8.5A3.5 3.5 0 1 0 12 15.5 3.5 3.5 0 1 0 12 8.5z"/><path stroke-width="1.5" d="M19.4 15a7.8 7.8 0 0 0 .1-6l2-1.2-2-3.5-2.2 1a8 8 0 0 0-5.6-2l-.4-2.4H9.7L9.3 3a8 8 0 0 0-5.6 2l-2.2-1-2 3.5 2 1.2a7.8 7.8 0 0 0 0 6l-2 1.2 2 3.5 2.2-1a8 8 0 0 0 5.6 2l.4 2.4h3.2l.4-2.4a8 8 0 0 0 5.6-2l2.2 1 2-3.5-2-1.2z"/></svg>
          </button>
          <button id="btnSignIn" class="px-3 py-2 rounded-lg brand-grad text-slate-900 font-medium shadow-md hover:opacity-90">Accedi a Gmail</button>
          <button id="btnChangeAccount" class="px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600">Cambia account</button>
        </div>
      </div>
    </div>
  </header>

  <!-- PAGE -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-8">
    <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4">
      <div>
        <div class="text-3xl font-semibold" id="pageTitle">Home</div>
        <div class="text-sm text-slate-400">Monitor live e ultimi allarmi per filiale</div>
      </div>
      <div class="flex items-center gap-3">
        <label class="text-sm text-slate-400">Filiale</label>
        <select id="filialeSelect" class="bg-slate-900 border border-white/10 rounded-lg px-3 py-2"></select>
      </div>
    </div>

    <!-- Barra stato globale -->
    <div id="statusBar" class="glass scanbar rounded-xl p-3 hidden">
      <div class="flex flex-wrap items-center gap-2 text-sm" id="statusBadges"></div>
    </div>

    <!-- ROUTES -->
    <section id="route-home" class="space-y-6">
      <div class="grid md:grid-cols-[minmax(360px,760px),1fr] gap-6">
        <!-- LIVE -->
        <div class="stream-outer">
          <div class="mb-2 flex items-center gap-3">
            <div class="flex-1">
              <label class="block text-xs text-slate-400 mb-1">Dimensione schermo LIVE</label>
              <input id="liveSize" type="range" min="60" max="92" value="75" class="w-full">
            </div>
            <button id="btnReconnect" class="mt-6 px-3 py-2 rounded-lg bg-slate-700 hover:bg-slate-600">Riconnetti</button>
            <button id="btnOpenProvider" class="mt-6 px-3 py-2 rounded-lg bg-sky-700 hover:bg-sky-600">Apri sito live</button>
          </div>

          <div class="stream-box" id="liveStreamBox">
            <div class="live-toolbar">
              <div class="text-xs sm:text-sm truncate">
                <span class="opacity-60">Provider:</span> <span id="liveProvider" class="font-medium">—</span>
                <span class="mx-2">·</span>
                <span class="opacity-80">ID:</span> <span id="liveSid" class="font-mono"></span>
                <span class="mx-2">·</span>
                <span class="opacity-80">Password:</span> <span id="livePwd" class="font-mono"></span>
              </div>
              <div class="ml-auto flex items-center gap-2">
                <button id="btnCopySid" class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 text-xs">Copia ID</button>
                <button id="btnCopyPwd" class="px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 text-xs">Copia Password</button>
              </div>
            </div>

            <div id="statusBox" class="p-2 text-center text-xs text-slate-300"></div>
            <div id="noStream" class="w-full h-full grid place-items-center text-slate-400 text-sm p-6">Nessuna live avviata</div>
            <video id="webrtcVideo" class="hidden stream-media" autoplay muted playsinline controls></video>
            <iframe id="liveFrame" class="hidden stream-frame" allow="camera; microphone; display-capture"></iframe>
          </div>
          <div id="errorBox" class="text-xs text-rose-300 min-h-5"></div>
        </div>

        <!-- Colonna destra -->
        <div class="flex flex-col gap-6">
          <div id="checkFilialiPanel" class="glass rounded-2xl p-5 space-y-3">
            <div class="font-medium tracking-wide mb-2">Check filiali</div>
            <div id="checkFilialiRows" class="space-y-2"></div>
          </div>

          <div class="glass rounded-2xl p-5 space-y-3">
            <div class="font-medium tracking-wide mb-2">Filiali & stato</div>
            <div id="filialiDescWrap" class="space-y-2"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="route-storico" class="hidden space-y-6">
      <div id="storicoWrap" class="space-y-6"></div>
    </section>

    <section id="route-impostazioni" class="hidden space-y-6">
      <div class="glass rounded-2xl p-5">
        <div class="font-medium mb-3">Profilo</div>
        <div class="grid sm:grid-cols-2 gap-4">
          <label class="block text-sm text-slate-300">Nome utente
            <input id="usernameInput" class="mt-1 w-full bg-slate-950 border border-white/10 rounded-lg px-3 py-2" placeholder="Es. Mario" />
          </label>
        </div>
      </div>

      <!-- Impostazioni Filiali -->
      <div class="glass rounded-2xl p-5">
        <div class="flex items-center justify-between">
          <div class="font-medium">Filiali</div>
          <button id="btnAddFiliale" class="px-3 py-2 rounded-lg bg-emerald-600/90 hover:bg-emerald-600">Aggiungi filiale</button>
        </div>
        <div id="filialiList" class="mt-4 space-y-3"></div>
        <div class="mt-2 text-xs text-slate-400">
          <b>Provider VDO.Ninja</b> = embed diretto in pagina (consigliato).<br>
          <b>ScreenStream (sito)</b> = apre screenstream.io in nuova scheda con ID/Password compilati.
        </div>
      </div>

      <div class="text-xs text-slate-500">Le impostazioni sono salvate nel tuo browser (LocalStorage).</div>
    </section>
  </main>

  <!-- MODAL: Impostazioni avanzate -->
  <div id="advModal" class="overlay" style="z-index:100;">
    <div class="glass rounded-2xl p-6 w-[min(760px,92vw)]">
      <div class="flex items-center justify-between mb-4">
        <div class="text-lg font-medium">Impostazioni avanzate</div>
        <button id="advClose" class="px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600">Chiudi</button>
      </div>
      <div id="advGate" class="space-y-3">
        <div class="text-sm text-slate-300">Inserisci password per sbloccare le impostazioni:</div>
        <input id="advPwd" type="password" class="w-full bg-slate-950 border border-white/10 rounded-lg px-3 py-2" placeholder="Password" />
        <button id="advUnlock" class="px-3 py-2 rounded-lg bg-amber-500/90 hover:bg-amber-500">Sblocca</button>
      </div>
      <div id="advBody" class="hidden space-y-4">
        <div class="grid sm:grid-cols-2 gap-4">
          <label class="block text-sm text-slate-300">Google Client ID
            <input id="advClientId" class="mt-1 w-full bg-slate-950 border border-white/10 rounded-lg px-3 py-2" placeholder="xxxx.apps.googleusercontent.com" />
          </label>
          <label class="block text-sm text-slate-300">Google API Key (opzionale)
            <input id="advApiKey" class="mt-1 w-full bg-slate-950 border border-white/10 rounded-lg px-3 py-2" placeholder="AIza..." />
          </label>
        </div>
        <div class="grid sm:grid-cols-2 gap-4">
          <label class="block text-sm text-slate-300">Query Gmail allarmi (default)
            <input id="advGmailQuery" class="mt-1 w-full bg-slate-950 border border-white/10 rounded-lg px-3 py-2" />
          </label>
          <label class="block text-sm text-slate-300">Regex temperatura
            <input id="advTempRx" class="mt-1 w-full bg-slate-950 border border-white/10 rounded-lg px-3 py-2" />
          </label>
        </div>
        <div class="grid sm:grid-cols-2 gap-4">
          <label class="block text-sm text-slate-300">Login hint (consiglia account)
            <input id="advLoginHint" class="mt-1 w-full bg-slate-950 border border-white/10 rounded-lg px-3 py-2" placeholder="es. resinellialimentari@gmail.com" />
          </label>
          <label class="block text-sm text-slate-300">Scopes (opzionale)
            <input id="advScopes" class="mt-1 w-full bg-slate-950 border border-white/10 rounded-lg px-3 py-2" placeholder="https://www.googleapis.com/auth/gmail.readonly" />
          </label>
        </div>
        <div class="text-xs text-slate-400">Origin da inserire nel Client OAuth (GitHub Pages): <code id="originsHint"></code></div>
        <div class="flex flex-wrap gap-2 justify-end">
          <button id="advTest"  class="px-3 py-2 rounded-lg bg-blue-500/90 hover:bg-blue-500">Test accesso</button>
          <button id="advSave"  class="px-3 py-2 rounded-lg bg-emerald-600/90 hover:bg-emerald-600">Salva</button>
          <button id="advReset" class="px-3 py-2 rounded-lg bg-red-700/80 hover:bg-red-600/80">Reset LocalStorage</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal row details -->
  <div id="rowModal" class="overlay">
    <div id="rowModalBody"></div>
  </div>

<script>
/**************** CONFIG ****************/
const DEFAULTS = {
  CLIENT_ID: "882609618607-c0e975cg1ughd4bi76hnee58c2ka6h2m.apps.googleusercontent.com",
  API_KEY: "",
  SCOPES: "https://www.googleapis.com/auth/gmail.readonly",
  GMAIL_QUERY: "newer_than:30d (subject:(temperatura) OR subject:(allarme) OR subject:(temperature))",
  TEMP_RX: "(-?\\d+(?:[\\.,]\\d+)?)\\s*(?:°\\s*[Cc]|gradi)",
  LOGIN_HINT: "resinellialimentari@gmail.com"
};

/**************** STATO ****************/
let cfg = {};
let tokenClient;
let gmailReady = false;

/* Provider supportati:
   - 'vdo'  -> VDO.Ninja (iframe, consigliato)
   - 'ssite'-> ScreenStream (apre sito esterno con join precompilato)
*/
const DEFAULT_FILIALI = [
  {
    id: 'castione',
    name: 'Resinelli Castione',
    email: 'allarmi@edilrepairs.ch',
    provider: 'vdo',
    streamUrl: '',               // non usato per vdo
    streamUser: '72500366',      // ID/alias
    streamPass: 'Yachc6',        // Password attuale
    streamAudio: false
  },
  {
    id: 'santantonino',
    name: "Resinelli Sant'Antonino",
    email: 'allarmi@edilrepairs.ch',
    provider: 'vdo',
    streamUrl: '',
    streamUser: '72500366',
    streamPass: 'Yachc6',
    streamAudio: false
  },
  {
    id: 'losone',
    name: 'Resinelli Losone',
    email: 'allarmi@edilrepairs.ch',
    provider: 'vdo',
    streamUrl: '',
    streamUser: '72500366',
    streamPass: 'Yachc6',
    streamAudio: false
  }
];

let state = { username: '', filiali: [], history: {} };

/**************** STORAGE ****************/
function loadState(){
  const s = JSON.parse(localStorage.getItem('resinelli_monitor')||'{}');
  state.username = s.username || '';
  const incoming = Array.isArray(s.filiali) && s.filiali.length ? s.filiali : JSON.parse(JSON.stringify(DEFAULT_FILIALI));
  state.filiali = incoming.map((f,i)=>({
    id: f.id || ('f'+i),
    name: f.name || ('Filiale '+(i+1)),
    email: f.email || 'allarmi@edilrepairs.ch',
    provider: f.provider || 'vdo',
    streamUrl: f.streamUrl || '',
    streamUser: (typeof f.streamUser==='string' ? f.streamUser : ''),
    streamPass: (typeof f.streamPass==='string' ? f.streamPass : ''),
    streamAudio: !!f.streamAudio
  }));
  state.history  = s.history || {};
  cfg = Object.assign({}, DEFAULTS, s.cfg||{});
}
function saveState(){
  localStorage.setItem('resinelli_monitor', JSON.stringify({ ...state, cfg }));
}

/**************** HELPERS ****************/
const $ = (sel)=> document.querySelector(sel);
function el(html){ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstElementChild }
function fmtDate(d){ return new Intl.DateTimeFormat('it-CH',{dateStyle:'medium', timeStyle:'short'}).format(d) }
function toNumber(str){ return parseFloat(String(str).replace(',', '.')) }
function normalizeText(s){ return (s||'').replace(/[–—−]/g,'-').replace(/\s+/g,' ').trim(); }
function statusCellKey(subject){ const m=(subject||'').match(/Allarme temperatura:\s*([^\(]+)\s*\(([^\)]+)\)/i); return m? normalizeText(m[1]).toLowerCase() : normalizeText(subject||'').toLowerCase(); }
function copyTxt(t){ try{ return navigator.clipboard.writeText(t||''); }catch{} }

/*********** LIVE height ***********/
function uiBindLiveSizer() {
  const input = $('#liveSize');
  const box = $('#liveStreamBox');
  if (!input || !box) return;
  let val = localStorage.getItem('live_h') || input.value || '75';
  input.value = val;
  box.style.setProperty('--live-h', val + 'svh');
  input.addEventListener('input', () => {
    val = input.value;
    localStorage.setItem('live_h', val);
    box.style.setProperty('--live-h', val + 'svh');
  });
}

/**************** LIVE (provider-aware) ****************/
let webrtcSession = null;
function setStatus(msg){ const el=$('#statusBox'); if(el) el.textContent = msg || ""; }
function showError(msg){ $('#errorBox').textContent = msg || ""; }
function cleanupWebRTC(){ try{ if(webrtcSession?.pc){ webrtcSession.pc.getTransceivers?.().forEach(t=>t.stop?.()); webrtcSession.pc.getSenders?.().forEach(s=>s.track?.stop?.()); webrtcSession.pc.getReceivers?.().forEach(r=>r.track?.stop?.()); webrtcSession.pc.close?.(); } }catch{} webrtcSession=null; }
async function stopWhepResource(){ if(webrtcSession?.resourceUrl){ try{ await fetch(webrtcSession.resourceUrl, { method:'DELETE', mode:'cors', headers: webrtcSession.authHeaders || {} }); }catch{} } }

function buildVdoViewUrl(id, pwd, label, rawUrl){
  // Se è stato incollato un URL VDO completo, usalo direttamente
  if (rawUrl && /vdo\.ninja/.test(rawUrl)) {
    const u = new URL(rawUrl);
    u.searchParams.set('cleanoutput','1');
    u.searchParams.set('autostart','1');
    u.searchParams.set('embed','1');
    if (label) u.searchParams.set('label', label);
    return u.toString();
  }
  // Altrimenti costruisci dal solo ID/Password
  const p = new URLSearchParams();
  if (id)  p.set('view', id);        // alias "v"
  if (pwd) { p.set('password', pwd); p.set('p', pwd); } // compat col formato dell'app
  p.set('cleanoutput','1');
  p.set('autostart','1');
  p.set('embed','1');
  if (label) p.set('label', label);
  return `https://vdo.ninja/?${p.toString()}`;
}
function buildVdoPushUrl(id, pwd){
  const p = new URLSearchParams();
  if (id)  p.set('push', id);
  if (pwd) p.set('password', pwd);
  p.set('screenshare','1');  // condivisione schermo su telefono
  p.set('autostart','1');
  p.set('cleanish','1');
  return `https://vdo.ninja/?${p.toString()}`;
}
function buildScreenStreamJoinUrl(id, pwd){
  // apre il sito con i campi da compilare manualmente se non prende query
  return `https://screenstream.io/`; // il form compare lì; i browser bloccheranno l'auto-compilazione cross origin
}

function updateLiveToolbar(){
  const f = state.filiali.find(x=>x.id === $('#filialeSelect').value);
  $('#liveProvider').textContent = f?.provider === 'vdo' ? 'VDO.Ninja' : 'ScreenStream (sito)';
  $('#liveSid').textContent = f?.streamUser || '—';
  $('#livePwd').textContent = f?.streamPass || '—';
}

async function startLiveForCurrent(){
  const frame = $('#liveFrame'); const video = $('#webrtcVideo'); const none = $('#noStream');
  frame.classList.add('hidden'); video.classList.add('hidden'); none.classList.remove('hidden');
  setStatus(''); showError('');
  await stopWhepResource(); cleanupWebRTC();

  const f = state.filiali.find(x=>x.id === $('#filialeSelect').value);
  if(!f){ showError('Nessuna filiale selezionata.'); return; }
  updateLiveToolbar();

  if (f.provider === 'vdo'){
    const url = buildVdoViewUrl(f.streamUser, f.streamPass, f.name, f.streamUrl);
    frame.src = url;
    frame.classList.remove('hidden');
    none.classList.add('hidden');
    setStatus('VDO.Ninja embed');
    return;
  }

  // Provider: screenstream (solo sito esterno). Dentro il riquadro lasciamo un messaggio.
  none.classList.remove('hidden');
  none.innerHTML = `<div class="text-center text-sm text-slate-300">
    Usa il pulsante <b>Apri sito live</b> per aprire screenstream.io in nuova scheda.<br/>
    ID: <span class="font-mono">${f.streamUser||'—'}</span> · Password: <span class="font-mono">${f.streamPass||'—'}</span>
  </div>`;
  setStatus('ScreenStream (apri in nuova scheda)');
}

/**************** CHECK/UX ****************/
function computeFilialeHasActiveAlarm(fid){
  const rows = (state.history[fid]||[]).slice().sort((a,b)=>a.date-b.date);
  const lastByCell = new Map();
  for(const r of rows){ const key = r.cellKey || statusCellKey(r.subject); lastByCell.set(key, r.status); }
  for(const st of lastByCell.values()){ if(st==='alto') return true; }
  return false;
}
function runCheckFiliali(){
  const wrap = $('#checkFilialiRows'); wrap.innerHTML = '';
  (state.filiali||[]).forEach(filiale=>{
    const row = el(`<div class="flex items-center justify-between text-sm">
      <div class="w-56 truncate text-slate-300">${filiale.name}</div>
      <div class="flex items-center gap-3">
        <div class="text-xs text-slate-400" id="stat-${filiale.id}">—</div>
      </div>
    </div>`);
    const rows = state.history[filiale.id] || [];
    const last = rows.slice().sort((a,b)=>b.date-a.date)[0] || null;
    const hasActive = computeFilialeHasActiveAlarm(filiale.id);
    const txt = hasActive ? 'ALLARME' : 'OK';
    const when = last ? ' · ' + fmtDate(new Date(last.date)) : '';
    row.querySelector(`#stat-${filiale.id}`).innerHTML =
      `<span class="px-2 py-0.5 rounded-md ${hasActive?'bg-red-500/15 text-red-300 border border-red-500/30':'bg-emerald-500/15 text-emerald-300 border border-emerald-500/30'}">${txt}</span>${when}`;
    wrap.appendChild(row);
  });
}
function uiRenderFilialiDesc(){
  const wrap = $('#filialiDescWrap'); wrap.innerHTML = '';
  state.filiali.forEach(filiale=>{
    const rows = state.history[filiale.id] || [];
    const hasActive = computeFilialeHasActiveAlarm(filiale.id);
    const last = rows.length ? rows.slice().sort((a,b)=>b.date-a.date)[0] : null;
    const card = el(`<div class="glass rounded-xl p-3">
      <div class="flex items-center gap-3">
        <div class="flex-1 min-w-0">
          <div class="font-medium text-slate-200 truncate">${filiale.name}</div>
          <div class="text-xs text-slate-400 mt-1">
            Provider: <b>${filiale.provider==='vdo'?'VDO.Ninja':'ScreenStream (sito)'}</b>
            · ID: <span class="font-mono">${filiale.streamUser||'—'}</span>
            · Password: <span class="font-mono">${filiale.streamPass||'—'}</span>
          </div>
        </div>
        <div>${hasActive
          ? '<span class="px-2 py-0.5 text-xs rounded-md bg-red-500/15 text-red-300 border border-red-500/30">ALLARME</span>'
          : '<span class="px-2 py-0.5 text-xs rounded-md bg-emerald-500/15 text-emerald-300 border border-emerald-500/30">OK</span>'}</div>
        <button class="px-2 py-1 rounded-md bg-slate-700 hover:bg-slate-600 text-xs" data-open-live="${filiale.id}">Apri live</button>
      </div>
      ${last? `<div class="text-xs text-slate-500 mt-1">Ultimo evento: ${fmtDate(new Date(last.date))}</div>`:''}
    </div>`);
    card.querySelector('[data-open-live]').addEventListener('click', ()=>{
      $('#filialeSelect').value = filiale.id;
      startLiveForCurrent();
      document.getElementById('liveStreamBox')?.scrollIntoView({behavior:'smooth', block:'center'});
    });
    wrap.appendChild(card);
  });
}

/**************** POPUP DETTAGLI ****************/
function uiOpenRowDetails(row, filialeName){
  const modal = $('#rowModal'); const body = $('#rowModalBody');
  let cella = ''; let filiale = filialeName || ''; let subject = row.subject || '';
  let temp = isFinite(row.temp) ? row.temp.toFixed(1) + ' °C' : '—'; let minmax = '—';
  const m = subject.match(/Allarme temperatura:\s*([^\(]+)\s*\(([^\)]+)\)/i);
  if (m) { cella = m[1].trim(); filiale = m[2].trim(); } else { cella = subject; }
  if (isFinite(row.min) && isFinite(row.max)) { minmax = row.min + '–' + row.max + ' °C'; }
  body.innerHTML = `
    <div class="mb-2 text-lg font-semibold">${cella}</div>
    <div class="mb-2 text-sm text-slate-400">Filiale: <span class="font-medium text-slate-200">${filiale}</span></div>
    <div class="mb-2 text-sm text-slate-400">Temperatura: <span class="font-medium text-slate-200">${temp}</span></div>
    <div class="mb-2 text-sm text-slate-400">Range min–max: <span class="font-medium text-slate-200">${minmax}</span></div>
    <div class="mb-2 text-sm text-slate-400">Data/ora: <span class="font-medium text-slate-200">${fmtDate(new Date(row.date))}</span></div>
    <div class="mb-2 text-sm text-slate-400">Subject: <span class="font-medium text-slate-200">${subject}</span></div>
    <div class="mt-4 flex justify-end"><button id="rowModalClose" class="px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600">Chiudi</button></div>
  `;
  modal.classList.add('show');
  $('#rowModalClose').onclick = () => modal.classList.remove('show');
  modal.onclick = (e) => { if (e.target === modal) modal.classList.remove('show'); };
}

/**************** ROUTER & STATUS ****************/
const routes = ['home','storico','impostazioni'];
function setActiveTab(hash){ document.querySelectorAll('.tab-btn').forEach(b=>{ const r=b.getAttribute('data-route'); b.classList.toggle('active', r===hash); }); }
function checkFilialiStatus(){
  const bar = $('#statusBar'); const badges = $('#statusBadges'); badges.innerHTML = '';
  const items = state.filiali.map(f=>{
    const rows = (state.history[f.id]||[]);
    const last = rows.slice().sort((a,b)=>b.date-a.date)[0];
    const isAlarm = computeFilialeHasActiveAlarm(f.id);
    return { name:f.name, last, isAlarm };
  });
  if(!items.length){ bar.classList.add('hidden'); return }
  items.forEach(it=>{
    const color = it.isAlarm? 'bg-red-500/15 text-red-300 border border-red-500/30' : 'bg-emerald-500/15 text-emerald-300 border border-emerald-500/30';
    badges.appendChild(el(`<span class="px-2 py-1 rounded-md ${color} text-xs">${it.name}${it.last? ' · '+fmtDate(new Date(it.last.date)) : ''}</span>`));
  });
  bar.classList.remove('hidden');
}
function go(route){
  routes.forEach(r=> document.getElementById('route-'+r).classList.toggle('hidden', r!==route));
  $('#pageTitle').textContent = route.charAt(0).toUpperCase()+route.slice(1);
  setActiveTab('#'+route);
  if(route==='storico') renderStorico();
  if(route==='home'){ checkFilialiStatus(); runCheckFiliali(); uiRenderFilialiDesc(); uiBindLiveSizer(); }
  if(route==='impostazioni') renderImpostazioni();
  history.replaceState(null, '', '#'+route);
}
window.addEventListener('hashchange', ()=>{ const r = (location.hash||'#home').slice(1); if(routes.includes(r)) go(r); });

/**************** IMPOSTAZIONI & STORICO ****************/
function populateFilialeSelect(){ const sel = $('#filialeSelect'); sel.innerHTML = (state.filiali||[]).map(f=>`<option value="${f.id}">${f.name}</option>`).join(''); }

function renderImpostazioni(){
  $('#usernameInput').value = state.username || '';
  const list = $('#filialiList'); list.innerHTML = '';
  (state.filiali||[]).forEach(f=>{
    const card = el(`<div class="glass rounded-xl p-3">
      <div class="grid md:grid-cols-9 gap-3 items-end">
        <label class="block text-sm text-slate-300">Nome
          <input data-k="name" class="mt-1 w-full bg-slate-950 border border-white/10 rounded-lg px-3 py-2" value="${f.name}" />
        </label>
        <label class="block text-sm text-slate-300">Email storico
          <input data-k="email" class="mt-1 w-full bg-slate-950 border border-white/10 rounded-lg px-3 py-2" value="${f.email}" />
        </label>
        <label class="block text-sm text-slate-300">Provider
          <select data-k="provider" class="mt-1 w-full bg-slate-950 border border-white/10 rounded-lg px-3 py-2">
            <option ${f.provider==='vdo'?'selected':''} value="vdo">VDO.Ninja (iframe)</option>
            <option ${f.provider==='ssite'?'selected':''} value="ssite">ScreenStream (sito esterno)</option>
          </select>
        </label>
        <label class="block text-sm text-slate-300">URL (solo ScreenStream se necessario)
          <input data-k="streamUrl" class="mt-1 w-full bg-slate-950 border border-white/10 rounded-lg px-3 py-2" value="${f.streamUrl||''}" placeholder="https://screenstream.io/" />
        </label>
        <label class="block text-sm text-slate-300">ID live
          <input data-k="streamUser" class="mt-1 w-full bg-slate-950 border border-white/10 rounded-lg px-3 py-2" value="${f.streamUser||''}" />
        </label>
        <label class="block text-sm text-slate-300">Password live
          <input data-k="streamPass" class="mt-1 w-full bg-slate-950 border border-white/10 rounded-lg px-3 py-2" value="${f.streamPass||''}" />
        </label>
        <label class="flex items-center gap-2 text-sm text-slate-300 mt-7">
          <input type="checkbox" data-k="streamAudio" ${f.streamAudio?'checked':''} class="accent-emerald-500">
          Audio (se supportato)
        </label>
        <div class="flex gap-2 mt-7">
          <button data-act="open" class="px-3 py-1.5 rounded-lg bg-slate-700 hover:bg-slate-600">Apri live</button>
          <button data-act="site" class="px-3 py-1.5 rounded-lg bg-blue-500/90 hover:bg-blue-500">Apri sito live</button>
          <button data-act="push" class="px-3 py-1.5 rounded-lg bg-sky-600/90 hover:bg-sky-600">Apri link PUSH (telefono)</button>
        </div>
        <div class="flex gap-2 mt-7 justify-end">
          <button data-act="save" class="px-3 py-1.5 rounded-lg bg-emerald-600/90 hover:bg-emerald-600">Salva</button>
          <button data-act="del" class="px-3 py-1.5 rounded-lg bg-red-700/80 hover:bg-red-600/80">Elimina</button>
        </div>
      </div>
    </div>`);

    card.querySelector('[data-act="save"]').addEventListener('click', ()=>{
      card.querySelectorAll('[data-k]').forEach(inp=>{
        const k = inp.dataset.k;
        if (inp.type==='checkbox') f[k] = inp.checked;
        else f[k] = inp.value;
      });
      saveState(); populateFilialeSelect(); checkFilialiStatus(); runCheckFiliali(); uiRenderFilialiDesc();
      alert('Salvato.');
    });
    card.querySelector('[data-act="del"]').addEventListener('click', ()=>{
      if(!confirm('Eliminare la filiale?')) return;
      state.history[f.id] = [];
      state.filiali = state.filiali.filter(x=>x.id!==f.id);
      saveState(); renderImpostazioni(); populateFilialeSelect(); checkFilialiStatus(); runCheckFiliali(); uiRenderFilialiDesc();
    });
    card.querySelector('[data-act="open"]').addEventListener('click', ()=>{
      $('#filialeSelect').value = f.id; startLiveForCurrent(); go('home');
    });
    card.querySelector('[data-act="site"]').addEventListener('click', ()=>{
      if (f.provider==='vdo'){
        window.open(buildVdoViewUrl(f.streamUser, f.streamPass, f.name), '_blank', 'noopener');
      } else {
        window.open(buildScreenStreamJoinUrl(f.streamUser, f.streamPass), '_blank', 'noopener');
      }
    });
    card.querySelector('[data-act="push"]').addEventListener('click', ()=>{
      const url = (f.provider==='vdo')
        ? buildVdoPushUrl(f.streamUser, f.streamPass)
        : buildScreenStreamJoinUrl(f.streamUser, f.streamPass);
      window.open(url, '_blank', 'noopener');
    });

    list.appendChild(card);
  });
}

function renderStorico(){
  const wrap = $('#storicoWrap'); wrap.innerHTML = '';
  for(const f of state.filiali){
    const rows = (state.history[f.id]||[]).slice().sort((a,b)=>b.date-a.date);
    const openCount = (()=>{ const lastByCell=new Map(); for(const r of rows.slice().reverse()){ const key=r.cellKey||statusCellKey(r.subject); lastByCell.set(key,r.status); } let c=0; for(const st of lastByCell.values()){ if(st==='alto') c++; } return c; })();
    const section = el(`<div class="glass rounded-2xl p-5">
      <div class="flex items-center justify-between mb-3">
        <div class="font-medium">${f.name}</div>
        <div class="text-xs text-slate-400">${rows.length} eventi · ${openCount} allarmi aperti</div>
      </div>
      <div class="overflow-x-auto"><table class="min-w-full text-sm">
        <thead class="text-slate-400"><tr>
          <th class="text-left py-2 pr-4">Data</th>
          <th class="text-left py-2 pr-4">Stato</th>
          <th class="text-left py-2 pr-4">Temperatura</th>
          <th class="text-left py-2 pr-4">Range</th>
          <th class="text-left py-2 pr-4">Cella/Descrizione</th>
          <th class="text-left py-2 pr-4">Oggetto</th>
        </tr></thead>
        <tbody></tbody></table></div></div>`);
    const tbody = section.querySelector('tbody');
    rows.forEach(r=>{
      let cella=''; let subject=r.subject||''; let minmax='—';
      const m = subject.match(/Allarme temperatura:\s*([^\(]+)\s*\(([^\)]+)\)/i);
      if (m) cella = m[1].trim() + ' (' + m[2].trim() + ')'; else cella = subject;
      if (isFinite(r.min) && isFinite(r.max)) minmax = r.min + '–' + r.max + ' °C';
      const badge = (r.status==='alto')
        ? '<span class="px-2 py-0.5 text-xs rounded-md bg-red-500/15 text-red-300 border border-red-500/30">ALLARME</span>'
        : '<span class="px-2 py-0.5 text-xs rounded-md bg-emerald-500/15 text-emerald-300 border border-emerald-500/30">OK</span>';
      const tr = el(`<tr class="border-t border-white/10 cursor-pointer hover:bg-white/5">
        <td class="py-2 pr-4 whitespace-nowrap">${fmtDate(new Date(r.date))}</td>
        <td class="py-2 pr-4">${badge}</td>
        <td class="py-2 pr-4">${isFinite(r.temp)? (r.temp.toFixed(1)+' °C') : '—'}</td>
        <td class="py-2 pr-4">${minmax}</td>
        <td class="py-2 pr-4">${cella}</td>
        <td class="py-2 pr-4">${subject}</td>
      </tr>`);
      tr.addEventListener('click', ()=> uiOpenRowDetails(r, f.name));
      tbody.appendChild(tr);
    });
    wrap.appendChild(section);
  }
}

/**************** ====== (solo se userai di nuovo WHEP) ====== ****************/
/* Lasciamo gli stub per completezza: non usati con provider 'vdo' */
async function startWhep(){ showError('WHEP disabilitato (usa provider VDO.Ninja).'); }

/**************** AUTH (gapi + GIS) ****************/
async function waitForGapiLoad(maxMs = 10000){
  const t0 = Date.now();
  while (!window.gapi?.load) { if (Date.now() - t0 > maxMs) throw new Error("gapi non caricato"); await new Promise(r => setTimeout(r, 50)); }
}
async function initGapi(){
  await waitForGapiLoad();
  return new Promise((resolve, reject)=>{
    gapi.load('client', async ()=>{
      try{
        const opts = { discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"] };
        if (window.cfg?.API_KEY) opts.apiKey = window.cfg.API_KEY;
        await gapi.client.init(opts);
        resolve();
      }catch(e){ reject(e) }
    });
  });
}
function initGIS(){
  if (!cfg?.CLIENT_ID || !cfg.CLIENT_ID.endsWith('.apps.googleusercontent.com')) {
    alert('Devi impostare il Google OAuth CLIENT_ID.');
    openAdvancedModal();
    throw new Error('CLIENT_ID mancante');
  }
  if (window.tokenClient) return;
  window.tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: cfg.CLIENT_ID,
    scope: (cfg?.SCOPES || "https://www.googleapis.com/auth/gmail.readonly"),
    hint: cfg.LOGIN_HINT || undefined,
    callback: (resp)=>{ if (resp?.access_token){ gapi.client.setToken({ access_token: resp.access_token }); gmailReady = true; } }
  });
}
function signOut(){ try{ const tok = gapi?.client?.getToken?.(); if (tok?.access_token) google?.accounts?.oauth2?.revoke?.(tok.access_token, ()=>{}); gapi?.client?.setToken?.(null);}catch{} gmailReady = false; }
function signIn(){
  return new Promise( async (resolve, reject)=>{
    try{
      if (!window.gapi?.client) { await initGapi(); }
      if (!cfg?.CLIENT_ID || !cfg.CLIENT_ID.endsWith('.apps.googleusercontent.com')) { openAdvancedModal(); return reject(new Error('CLIENT_ID mancante')); }
      if (!window.tokenClient) { initGIS(); }
      try{ window.google?.accounts?.id?.disableAutoSelect?.(); }catch{}
      try{ const tok = window.gapi?.client?.getToken?.(); if (tok?.access_token) window.google?.accounts?.oauth2?.revoke?.(tok.access_token, ()=>{}); window.gapi?.client?.setToken?.(null);}catch{}
      window.tokenClient.callback = (r)=> r?.access_token ? resolve(r) : reject(r);
      window.tokenClient.requestAccessToken({ prompt: 'consent select_account', include_granted_scopes: false, hint: cfg.LOGIN_HINT || undefined });
    }catch(e){ reject(e); }
  });
}

/**************** GMAIL: parsing (allarme ma temp nel range = OK) ****************/
async function listMessages(q, max=200){ let msgs=[], pageToken; do{ const res=await gapi.client.gmail.users.messages.list({userId:'me', q, maxResults:100, pageToken}); const d=res.result; if(d.messages) msgs.push(...d.messages); pageToken=d.nextPageToken } while(pageToken && msgs.length<max); return msgs }
async function getMessage(id){ const res=await gapi.client.gmail.users.messages.get({userId:'me', id, format:'full'}); return res.result }
function decodeBody(body){ try{ return decodeURIComponent(escape(window.atob((body||'').replace(/-/g,'+').replace(/_/g,'/')))); }catch{ return '' } }
function getHeader(msg, name){ const h = msg.payload.headers.find(h=>h.name.toLowerCase()===name.toLowerCase()); return h? h.value: '' }

function parseTemperatures(subject, body){
  const s = normalizeText(subject); const b = normalizeText(body);
  const mTemp = b.match(/temperatura[^.\n\r]*?\b(?:è\s*di|di)\s*(-?\d+(?:[.,]\d+)?)/i) || s.match(/temperatura[^.\n\r]*?\b(?:è\s*di|di)\s*(-?\d+(?:[.,]\d+)?)/i);
  const mRange = b.match(/Dovrebbe:\s*da\s*(-?\d+(?:[.,]\d+)?)\s*a\s*(-?\d+(?:[.,]\d+)?)/i);
  let temp = mTemp ? toNumber(mTemp[1]) : NaN; const min = mRange ? toNumber(mRange[1]) : NaN; const max = mRange ? toNumber(mRange[2]) : NaN;
  if(!isFinite(temp)){ const near = b.match(/(-?\d+(?:[.,]\d+)?)(?=\s*(?:°\s*[Cc]|gradi))/i); if (near) temp = toNumber(near[1]); }
  if(!isFinite(temp)){
    const all = [...b.matchAll(/-?\d+(?:[.,]\d+)?/g)].map(m=>({v:toNumber(m[0]), i:m.index}));
    if (mRange) { const rs = mRange.index, re = rs + mRange[0].length; const candidates = all.filter(n => n.i < rs || n.i > re); if (candidates.length) temp = candidates[0].v; }
    else if (all.length){ temp = all[0].v; }
  }
  return { temp, min, max };
}

function inferStatusSmart(subject, body){
  const txt = (subject + '\n' + body).toLowerCase();
  const saysAlarm = /(allarme|alert|warning|alto|high|critical|critico)/.test(txt);
  const saysRestore = /(ripristin|rientrat|tornat|normalizzat|ritornat|ok|risolt|cleared|resolved)/.test(txt) && /temperatura|temp/.test(txt);
  if(saysRestore && !saysAlarm) return 'ok';
  if(saysAlarm) return 'alto';
  return null;
}

function extractCellAndFiliale(subject){
  const m = (subject||'').match(/Allarme temperatura:\s*([^\(]+)\s*\(([^\)]+)\)/i);
  if(m) return { cella: m[1].trim(), filiale: m[2].trim() };
  return { cella: subject||'', filiale: '' };
}

async function fetchAlarms(){
  const q = cfg.GMAIL_QUERY;
  const msgs = await listMessages(q, 600);
  for(const m of msgs){
    const msg = await getMessage(m.id);
    const subject = getHeader(msg,'Subject')||'(senza oggetto)';
    const d = new Date(Number(msg.internalDate));
    let body=''; (function extract(part){ if(!part) return;
      if(part.mimeType==='text/plain' && part.body?.data){ body += decodeBody(part.body.data) + '\n'; }
      if(part.parts) part.parts.forEach(extract);
      if(part.mimeType==='text/html' && !body && part.body?.data){ body = decodeBody(part.body.data).replace(/<[^>]+>/g,' '); }
    })(msg.payload);

    let status = inferStatusSmart(subject, body);
    if(!status) continue;

    const { temp, min, max } = parseTemperatures(subject, body);

    // Se è stato segnalato come allarme ma la temperatura è nel range -> OK (false positive)
    if(status==='alto' && isFinite(temp) && isFinite(min) && isFinite(max) && temp>=min && temp<=max){
      status = 'ok';
    }

    const { filiale: filialeName, cella } = extractCellAndFiliale(subject);
    const low = (subject+'\n'+body).toLowerCase();

    const fid = (function(){
      if(filialeName){
        const needle = filialeName.toLowerCase();
        const byHint = state.filiali.find(f => f.name.toLowerCase().includes(needle));
        if(byHint) return byHint.id;
      }
      for(const f of state.filiali){ if(low.includes(f.name.toLowerCase())) return f.id; }
      return $('#filialeSelect').value || state.filiali[0]?.id;
    })();

    const row = {
      date:+d, temp, min, max, status, subject, id:m.id, bodyPlain: body,
      cellKey: normalizeText(cella).toLowerCase()
    };
    if(!state.history[fid]) state.history[fid]=[];
    if(!state.history[fid].some(r=>r.id===row.id)) state.history[fid].push(row);
  }
  for(const fid of Object.keys(state.history)){
    state.history[fid] = state.history[fid].sort((a,b)=>a.date-b.date).slice(-2000);
  }
  saveState();
  checkFilialiStatus(); runCheckFiliali(); uiRenderFilialiDesc();
  if(location.hash==='#storico') renderStorico();
}

/**************** ADVANCED MODAL ****************/
function openAdvancedModal() {
  const modal = $('#advModal'); const gate = $('#advGate'); const body = $('#advBody');
  if (!modal || !gate || !body) return;
  modal.classList.add('show'); gate.classList.remove('hidden'); body.classList.add('hidden');
  const host = location.host; $('#originsHint').textContent = `https://${host}`;
  $('#advClientId').value = cfg?.CLIENT_ID || '';
  $('#advApiKey').value = cfg?.API_KEY || '';
  $('#advGmailQuery').value = cfg?.GMAIL_QUERY || '';
  $('#advTempRx').value = cfg?.TEMP_RX || '';
  $('#advLoginHint').value = cfg?.LOGIN_HINT || '';
  $('#advScopes').value = cfg?.SCOPES || DEFAULTS.SCOPES || '';
  setTimeout(()=>{ $('#advPwd').focus(); }, 100);
}

/**************** BOOT ****************/
window.addEventListener('DOMContentLoaded', async ()=>{
  loadState();
  populateFilialeSelect();

  document.querySelectorAll('.route-btn').forEach(b=> b.addEventListener('click', ()=> go(b.dataset.route.slice(1))));
  const initial = (location.hash || '#home'); setActiveTab(initial); go((initial||'#home').slice(1));

  $('#filialeSelect').addEventListener('change', ()=> startLiveForCurrent());
  if (state.filiali[0]) $('#filialeSelect').value = state.filiali[0].id;

  checkFilialiStatus(); runCheckFiliali(); uiRenderFilialiDesc(); uiBindLiveSizer();

  // LIVE controls
  $('#btnReconnect').addEventListener('click', ()=> startLiveForCurrent());
  $('#btnOpenProvider').addEventListener('click', ()=>{
    const f = state.filiali.find(x=>x.id === $('#filialeSelect').value);
    if(!f) return;
    const url = (f.provider==='vdo')
      ? buildVdoViewUrl(f.streamUser, f.streamPass, f.name)
      : buildScreenStreamJoinUrl(f.streamUser, f.streamPass);
    window.open(url,'_blank','noopener');
  });
  $('#btnCopySid').addEventListener('click', ()=>{ const f=state.filiali.find(x=>x.id===$('#filialeSelect').value); copyTxt(f?.streamUser||''); });
  $('#btnCopyPwd').addEventListener('click', ()=>{ const f=state.filiali.find(x=>x.id===$('#filialeSelect').value); copyTxt(f?.streamPass||''); });

  // Profilo & filiali
  $('#usernameInput').addEventListener('change', (e)=>{ state.username=e.target.value; saveState() });
  $('#btnAddFiliale').addEventListener('click', ()=>{
    state.filiali.push({
      id: (crypto?.randomUUID?.() || ('f'+Date.now())),
      name: 'Nuova filiale',
      email: 'allarmi@edilrepairs.ch',
      provider: 'vdo',
      streamUrl: '',
      streamUser: '',
      streamPass: '',
      streamAudio: false
    });
    saveState(); renderImpostazioni(); populateFilialeSelect();
  });

  // Advanced modal
  $('#btnAdvanced')?.addEventListener('click', ()=> openAdvancedModal());
  $('#advClose').onclick = ()=> $('#advModal').classList.remove('show');
  $('#advUnlock').onclick = ()=>{ if($('#advPwd').value==='979851'){ $('#advGate').classList.add('hidden'); $('#advBody').classList.remove('hidden'); setTimeout(()=>$('#advClientId').focus(),100); } else { alert('Password errata'); } };
  $('#advSave').onclick = ()=>{
    cfg.CLIENT_ID  = $('#advClientId').value.trim();
    cfg.API_KEY    = $('#advApiKey').value.trim();
    cfg.GMAIL_QUERY= $('#advGmailQuery').value.trim();
    cfg.TEMP_RX    = $('#advTempRx').value.trim();
    cfg.LOGIN_HINT = $('#advLoginHint').value.trim();
    cfg.SCOPES     = $('#advScopes').value.trim() || DEFAULTS.SCOPES;
    saveState();
    initGapi().then(()=>{ try{ initGIS(); }catch{} alert('Impostazioni salvate.'); }).catch(e=> alert('Errore init: ' + (e?.message || e)));
    $('#advModal')?.classList.remove('show');
  };
  $('#advTest').onclick = async ()=>{ try{ signOut(); await signIn(); await fetchAlarms(); alert('Accesso OK, storico aggiornato.'); } catch(e){ alert('Errore test accesso: ' + (e?.message || e)); } };
  $('#advReset').onclick = ()=>{ localStorage.removeItem('resinelli_monitor'); location.reload(); };

  async function forceAccountChooser(){
    try{
      if (!cfg?.CLIENT_ID || !cfg.CLIENT_ID.endsWith('.apps.googleusercontent.com')) { openAdvancedModal(); return; }
      if (!window.gapi?.client) { await initGapi(); }
      if (!window.tokenClient) { initGIS(); }
      signOut(); await new Promise(r=>setTimeout(r,50)); await signIn(); await fetchAlarms();
    }catch(e){ alert('Errore login: ' + (e?.message || e)); }
  }
  $('#btnSignIn').onclick = forceAccountChooser;
  $('#btnChangeAccount').onclick = forceAccountChooser;

  // avvia live
  startLiveForCurrent();

  // cleanup (se un domani userai WHEP)
  window.addEventListener('beforeunload', ()=>{ stopWhepResource(); cleanupWebRTC(); });
});
</script>
</body>
</html>
