<!DOCTYPE html>
<html lang="it" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resinelli Monitor</title>

  <!-- Favicon dinamica -->
  <link id="dynamic-favicon" rel="icon" href="data:," />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Identity Services + Gmail API -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>

  <!-- Jitsi Meet IFrame API -->
  <script src="https://meet.jit.si/external_api.js"></script>

  <script>
    /* Tailwind config (solo chiaro) */
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            acc:  "#2563eb",
            emerald: "#10b981",
            rose: "#e11d48",
            slateLine: "#E5E7EB",
          },
          boxShadow: {
            glass: "0 10px 25px rgba(0,0,0,.06)"
          },
          keyframes: {
            fade: { "0%": {opacity:0}, "100%": {opacity:1} },
            slide: { "0%": {transform:"translateY(6px)", opacity:.0}, "100%":{transform:"translateY(0)", opacity:1} },
            pulseSoft: { "0%,100%":{opacity:.7}, "50%":{opacity:1} },
            spin: { to: { transform: "rotate(360deg)" } },
            scan: { "0%": { transform: "translateX(-100%)" }, "60%": { transform: "translateX(100%)" }, "100%": { transform: "translateX(100%)" } }
          },
          animation: {
            fade: "fade .25s ease both",
            slide: "slide .3s ease both",
            pulseSoft: "pulseSoft 2s ease-in-out infinite",
            spin: "spin 1s linear infinite",
            scan: "scan 2.2s infinite",
          },
          borderRadius: { xl2: "1rem" }
        }
      }
    }
  </script>

  <style>
    :root{ --live-h: 75svh; }
    html,body{height:100%}
    body{ background:#fff; color:#0f172a; }
    .brand-grad{ background:linear-gradient(90deg, #60a5fa, #22d3ee); }
    .glass { background: rgba(255,255,255,.9); backdrop-filter: blur(10px); border: 1px solid #E5E7EB; box-shadow: 0 10px 25px rgba(0,0,0,.06); }
    .stream-box{ position:relative; width:100%; aspect-ratio:9/16; max-height:var(--live-h,75svh); background:#000; border:1px solid #E5E7EB; border-radius:14px; overflow:hidden }
    .stream-media, .stream-frame{ width:100%; height:100%; object-fit:contain; background:#000; border:0 }
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:70 }
    .overlay.show{ display:flex }
    .scanbar{ position:relative; overflow:hidden }
    .scanbar::after{ content:""; position:absolute; inset:0; background:linear-gradient(90deg,transparent,rgba(255,255,255,.5),transparent); transform:translateX(-100%); animation:scan 2.2s infinite }

    /* Skeletons */
    .skeleton{ position:relative; overflow:hidden; background: #F3F4F6; border-radius: 10px; min-height: 40px; }
    .skeleton::before{
      content:""; position:absolute; inset:0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.7), transparent);
      transform: translateX(-100%); animation: scan 1.6s infinite;
    }

    /* Spinner (border animato) */
    .spinner{ width:16px; height:16px; border:2px solid rgba(0,0,0,.15); border-top-color: rgba(0,0,0,.6); border-radius:9999px; animation: spin 1s linear infinite; }

    /* Bottoni unificati */
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:.5rem; padding:.5rem .75rem; border-radius: .8rem; font-size:.875rem; font-weight:600; background:#fff; border:1px solid #E5E7EB; box-shadow: 0 1px 0 rgba(0,0,0,.02); transition: box-shadow .15s, transform .15s; }
    .btn:hover{ box-shadow: 0 6px 16px rgba(0,0,0,.08); transform: translateY(-1px); }
    .btn:active{ transform: translateY(0); }
    .btn:focus{ outline: none; box-shadow: 0 0 0 3px rgba(37,99,235,.15); }
    .btn-primary{ background:#2563eb; color:#fff; border-color:#2563eb; }
    .btn-primary:hover{ filter: brightness(1.05); }
    .btn-positive{ background:#10b981; color:#fff; border-color:#10b981; }
    .btn-negative{ background:#e11d48; color:#fff; border-color:#e11d48; }
    .btn-ghost{ background:transparent; }

    /* Bubbles chat IA */
    .bubble{ display:flex; align-items:flex-start; gap:.6rem; }
    .bubble .avatar{ width:28px; height:28px; border-radius:9999px; background:#e5f0ff; display:grid; place-items:center; font-size:14px; }
    .bubble .msg{ background:#F8FAFC; border:1px solid #E5E7EB; border-radius:14px; padding:.6rem .75rem; line-height:1.25rem; }

    /* Badge */
    .badge{ display:inline-flex; align-items:center; gap:.35rem; padding:.25rem .5rem; border-radius:.6rem; font-size:.75rem; border:1px solid #E5E7EB; background:#fff; }

    /* Sticky filtri storico su desktop */
    @media (min-width: 1024px){
      #filterRangeWrap{
        position: sticky;
        top: 1rem;
        z-index: 30;
        background: #fff;
      }
    }

    /* Print */
    @media print{
      header, nav, #advModal, #rowModal, #aiReportModal, #statusBar, #route-impostazioni, #btnExportCsv, #btnPrint, #filterRangeWrap { display:none !important; }
      body{ background:#fff !important; color:#000 !important; }
      .glass{ background:#fff !important; border:none !important; box-shadow:none !important; }
      .print-footer{ position:fixed; bottom:0; left:0; right:0; font-size:12px; padding:8px 16px; display:flex; justify-content:flex-start; align-items:center; border-top:1px solid #ccc; }
      .print-logos{ display:none !important; } /* RIMOSSI LOGHI */
    }

    /* Modali responsive e scrollabili su mobile */
    .overlay .glass{
      max-height: 92svh;
      overflow: auto;
    }

    @media (max-width: 640px){
      /* Assicura padding interno e nessun taglio */
      .overlay .glass{
        width: min(96vw, 860px);
        margin: 2svh 0;
      }
    }

    /* Evita che il body sotto interferisca col tocco */
    .overlay{ overscroll-behavior: contain; }

    @supports (padding: max(0px)){
      header.glass{ padding-left: max(0px, env(safe-area-inset-left)); padding-right: max(0px, env(safe-area-inset-right)); }
      body{ padding-bottom: env(safe-area-inset-bottom); }
    }

    @media (max-width: 480px){
      .stream-box{ max-height: 88svh; }
    }
    /* ...existing code... */
  </style>
</head>
<body class="min-h-screen selection:bg-sky-200 selection:text-sky-900">

  <!-- ========== TOP BAR ========== -->
  <header class="glass sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div class="flex items-center gap-3">
          <div id="brandLogoBox" class="h-9 w-9 rounded-lg overflow-hidden grid place-items-center brand-grad">
            <img id="brandLogoImg" class="hidden h-full w-full object-cover" alt="Logo sito">
          </div>
          <div>
            <div class="text-lg font-semibold tracking-wide">Resinelli Monitor</div>
            <div class="text-[12px] opacity-70 -mt-0.5">Celle frigo ¬∑ live & storico</div>
          </div>
        </div>
        <nav class="flex items-center gap-1">
          <button data-route="#home" class="tab-btn btn" aria-label="Vai a Home">Home</button>
          <button data-route="#storico" class="tab-btn btn" aria-label="Vai a Storico">Storico</button>
          <button data-route="#impostazioni" class="tab-btn btn" aria-label="Vai a Impostazioni">Impostazioni</button>
        </nav>
        <div class="flex items-center gap-2">
          <button id="btnAdvanced" class="btn" title="Impostazioni avanzate" aria-label="Impostazioni avanzate">‚öôÔ∏è</button>
          <button id="btnSignIn" class="btn btn-primary" aria-label="Accedi a Gmail">Accedi a Gmail</button>
          <button id="btnChangeAccount" class="btn" aria-label="Cambia account">Cambia account</button>
        </div>
      </div>
    </div>
  </header>

  <!-- ========== LAYOUT ========== -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex flex-col md:flex-row gap-6">

      <!-- Sidebar -->
      <aside class="w-full md:w-72 flex-shrink-0">
        <div class="glass rounded-2xl mb-6 p-4 space-y-4">
          <!-- Logos -->
          <div class="flex items-center justify-between">
            <img id="sidebarSiteLogo" class="max-h-10 object-contain" alt="Logo sito"/>
            <img id="sidebarDevLogo" class="max-h-10 object-contain" alt="Logo dev"/>
          </div>
          <!-- Gmail status -->
          <div class="gmail-status flex items-center gap-3 text-sm">
            <span class="dot inline-block w-2.5 h-2.5 rounded-full bg-slate-400" aria-hidden="true"></span>
            <span id="gmail-status-text" aria-live="polite">Gmail</span>
            <span class="spinner" role="status" aria-live="polite" aria-label="Caricamento Gmail" id="gmailSpinner" style="display:none"></span>
            <!-- NEW: ultimo aggiornamento -->
            <span id="gmailLastSync" class="ml-2 text-xs opacity-60"></span>
            <button id="btnRefresh" class="btn text-xs ml-auto" aria-label="Rileggi Gmail">Aggiorna</button>
          </div>

          <!-- Quick stats -->
          <div class="text-xs opacity-70" id="quickStats">
            Nessun dato ancora. Accedi a Gmail per sincronizzare.
          </div>

          <!-- Pannello veloce KPI 24h -->
          <div id="quickKpi" class="grid grid-cols-2 gap-2 text-center">
            <div class="p-2 border rounded-lg">
              <div class="text-[11px] opacity-70">Attivi</div>
              <div id="kAttivi" class="text-lg font-semibold text-rose-600">0</div>
            </div>
            <div class="p-2 border rounded-lg">
              <div class="text-[11px] opacity-70">Risolti 24h</div>
              <div id="kRisolti" class="text-lg font-semibold text-emerald-600">0</div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main -->
      <main class="flex-1 py-6 space-y-8">

        <!-- Header pagina + selettore filiale -->
        <section class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-4 animate-fade">
          <div>
            <div class="text-3xl font-semibold" id="pageTitle">Home</div>
            <div class="text-sm opacity-70">Monitor live e ultimi allarmi per filiale</div>
          </div>
          <div class="flex items-center gap-3">
            <label class="text-sm opacity-70" for="filialeSelect">Filiale</label>
            <select id="filialeSelect" class="bg-white border border-[#E5E7EB] rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-200"></select>
          </div>
        </section>

        <!-- Barra stato globale -->
        <section id="statusBar" class="glass scanbar rounded-xl p-3 hidden">
          <div class="flex flex-wrap items-center gap-2 text-sm" id="statusBadges"></div>
        </section>

        <!-- ROUTES -->
        <section id="route-home" class="space-y-6">
          <div class="grid md:grid-cols-[minmax(360px,760px),1fr] gap-6">
            <!-- LIVE -->
            <div class="space-y-2">
              <div class="flex items-center gap-3">
                <div class="flex-1">
                  <label class="block text-xs opacity-70 mb-1" for="liveSize">Dimensione schermo LIVE</label>
                  <input id="liveSize" type="range" min="60" max="92" value="75" class="w-full" aria-label="Dimensione Live">
                </div>
                <button id="btnReconnect" class="btn" aria-label="Riconnetti live">Riconnetti</button>
                <button id="btnOpenProvider" class="btn btn-primary" aria-label="Apri su sito del provider">Apri sito live</button>
              </div>

              <div class="stream-box">
                <div class="absolute inset-x-0 top-0 h-10 flex items-center gap-2 px-2 bg-black/50 z-10 text-white">
                  <div class="text-[11px] sm:text-xs truncate">
                    <span class="opacity-70">Provider:</span> <span id="liveProvider" class="font-medium">‚Äî</span>
                    <span class="mx-2">¬∑</span>
                    <span class="opacity-70">ID:</span> <span id="liveSid" class="font-mono"></span>
                    <span class="mx-2">¬∑</span>
                    <span class="opacity-70">Password:</span> <span id="livePwd" class="font-mono"></span>
                  </div>
                  <div class="ml-auto flex items-center gap-2">
                    <button id="btnCopySid" class="btn text-xs !py-1 !px-2" aria-label="Copia ID">Copia ID</button>
                    <button id="btnCopyPwd" class="btn text-xs !py-1 !px-2" aria-label="Copia password">Copia Password</button>
                  </div>
                </div>

                <div id="statusBox" class="absolute left-0 right-0 top-10 text-center text-xs text-slate-200"></div>

                <div id="jitsiContainer" class="absolute inset-0 hidden" aria-live="polite"></div>
                <iframe id="liveFrame" class="hidden stream-frame" allow="autoplay; fullscreen; camera; microphone; display-capture" title="Live frame"></iframe>
                <video id="webrtcVideo" class="hidden stream-media" autoplay muted playsinline controls aria-label="Stream video"></video>

                <!-- Placeholder -->
                <div id="noStream" class="w-full h-full grid place-items-center text-slate-300 text-sm p-6">
                  <div class="text-center space-y-2">
                    <div class="text-3xl">üì°</div>
                    <div>Nessuna live avviata</div>
                  </div>
                </div>
              </div>
              <div id="errorBox" class="text-xs text-rose-600 min-h-5" aria-live="polite"></div>
            </div>

            <!-- Colonna destra -->
            <div class="flex flex-col gap-6">
              <div id="checkFilialiPanel" class="glass rounded-2xl p-5 space-y-3">
                <div class="font-medium tracking-wide mb-2">Check filiali</div>
                <div id="checkFilialiRows" class="space-y-2">
                  <!-- skeleton -->
                  <div class="skeleton h-8"></div>
                  <div class="skeleton h-8"></div>
                  <div class="skeleton h-8"></div>
                </div>
              </div>

              <div class="glass rounded-2xl p-5 space-y-3">
                <div class="flex items-center justify-between">
                  <div class="font-medium tracking-wide">Filiali & stato</div>
                  <button id="btnReportGlobal" class="btn btn-primary text-xs">Report IA globale</button>
                </div>
                <div id="filialiDescWrap" class="space-y-2">
                  <!-- skeleton -->
                  <div class="skeleton h-10"></div>
                  <div class="skeleton h-10"></div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section id="route-storico" class="hidden space-y-4">
          <div id="filterRangeWrap" class="flex flex-wrap items-center gap-2">
            <span class="text-sm opacity-70">Intervallo:</span>
            <button class="range-btn btn text-sm" data-range="24h">24h</button>
            <button class="range-btn btn text-sm" data-range="7d">7 giorni</button>
            <button class="range-btn btn text-sm" data-range="30d">30 giorni</button>
            <button class="range-btn btn text-sm" data-range="all">Tutto</button>

            <div class="flex items-center gap-2 ml-auto">
              <input id="histSearch" class="bg-white border border-slateLine rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-200" placeholder="Cerca cella/oggetto...">
              <select id="histStatus" class="bg-white border border-slateLine rounded-lg px-2 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-200" aria-label="Filtro stato">
                <option value="all">Tutti</option>
                <option value="alto">Solo allarmi</option>
                <option value="ok">Solo OK</option>
              </select>
              <select id="histSort" class="bg-white border border-slateLine rounded-lg px-2 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-200" aria-label="Ordinamento">
                <option value="date_desc">Data ‚Üì</option>
                <option value="date_asc">Data ‚Üë</option>
              </select>
              <button id="btnExportCsv" class="btn btn-positive text-sm">Esporta CSV</button>
              <button id="btnPrint" class="btn btn-primary text-sm">Stampa / PDF</button>
            </div>
          </div>
          <div id="storicoWrap" class="space-y-6">
            <!-- skeleton tabella -->
            <div class="glass rounded-xl p-4">
              <div class="skeleton h-6 mb-3"></div>
              <div class="skeleton h-10 mb-2"></div>
              <div class="skeleton h-10 mb-2"></div>
              <div class="skeleton h-10"></div>
            </div>
          </div>

          <!-- Footer stampa (solo testo senza loghi) -->
          <div class="print-footer">
            <div id="printFooterText">Storico Resinelli ‚Äî generato il <span id="printDate"></span></div>
          </div>
        </section>

        <section id="route-impostazioni" class="hidden space-y-6">
          <div class="glass rounded-2xl p-5">
            <div class="font-medium mb-3">Profilo</div>
            <div class="grid sm:grid-cols-2 gap-4">
              <label class="block text-sm">Nome utente
                <input id="usernameInput" class="mt-1 w-full bg-white border border-slateLine rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-200" placeholder="Es. Mario" />
              </label>
            </div>
          </div>

          <div class="glass rounded-2xl p-5">
            <div class="font-medium mb-3">Branding / Loghi</div>
            <div class="grid sm:grid-cols-3 gap-4">
              <label class="block text-sm">Logo header URL
                <input id="logoUrlInput" class="mt-1 w-full bg-white border border-slateLine rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-200" placeholder="https://..." />
              </label>
              <label class="block text-sm">Favicon URL
                <input id="iconUrlInput" class="mt-1 w-full bg-white border border-slateLine rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-200" placeholder="https://..." />
              </label>
              <label class="block text-sm">Logo sviluppatore URL
                <input id="devLogoUrlInput" class="mt-1 w-full bg-white border border-slateLine rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-200" placeholder="https://..." />
              </label>
            </div>
            <div class="mt-3">
              <button id="btnSaveBranding" class="btn btn-positive">Salva branding</button>
            </div>
          </div>

          <!-- Filiali -->
          <div class="glass rounded-2xl p-5">
            <div class="flex items-center justify-between">
              <div class="font-medium">Filiali</div>
              <button id="btnAddFiliale" class="btn btn-positive">Aggiungi filiale</button>
            </div>
            <div id="filialiList" class="mt-4 space-y-3"></div>
            <div class="mt-2 text-xs opacity-70">
              <b>Jitsi Meet</b> = embed diretto in pagina (stanza + password).<br>
              <b>VDO.Ninja</b> = embed diretto in pagina (view ID + password).<br>
              <b>WHEP/Worker</b> = placeholder (riattiva solo con endpoint compatibile).
            </div>
          </div>

          <div class="text-xs opacity-60">Le impostazioni sono salvate nel tuo browser (LocalStorage).</div>
        </section>
      </main>
    </div>
  </div>

  <!-- ========== MODALS ========== -->

  <!-- Advanced -->
  <div id="advModal" class="overlay" aria-modal="true" role="dialog">
    <div class="glass rounded-2xl p-6 w-[min(760px,92vw)] animate-slide">
      <div class="flex items-center justify-between mb-4">
        <div class="text-lg font-medium">Impostazioni avanzate</div>
        <button id="advClose" class="btn" aria-label="Chiudi impostazioni avanzate">Chiudi</button>
      </div>
      <div id="advGate" class="space-y-3">
        <div class="text-sm">Inserisci password per sbloccare le impostazioni:</div>
        <input id="advPwd" type="password" class="w-full bg-white border border-slateLine rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-200" placeholder="Password" />
        <button id="advUnlock" class="btn btn-primary">Sblocca</button>
      </div>
      <div id="advBody" class="hidden space-y-4">
        <div class="grid sm:grid-cols-2 gap-4">
          <label class="block text-sm">Google Client ID
            <input id="advClientId" class="mt-1 w-full bg-white border border-slateLine rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-200" placeholder="xxxx.apps.googleusercontent.com" />
          </label>
          <label class="block text-sm">Google API Key (opzionale)
            <input id="advApiKey" class="mt-1 w-full bg-white border border-slateLine rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-200" placeholder="AIza..." />
          </label>
        </div>
        <div class="grid sm:grid-cols-2 gap-4">
          <label class="block text-sm">Query Gmail allarmi (default)
            <input id="advGmailQuery" class="mt-1 w-full bg-white border border-slateLine rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-200" />
          </label>
          <label class="block text-sm">Regex temperatura
            <input id="advTempRx" class="mt-1 w-full bg-white border border-slateLine rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-200" />
          </label>
        </div>
        <div class="grid sm:grid-cols-2 gap-4">
          <label class="block text-sm">Login hint (consiglia account)
            <input id="advLoginHint" class="mt-1 w-full bg-white border border-slateLine rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-200" placeholder="es. resinellialimentari@gmail.com" />
          </label>
          <label class="block text-sm">Scopes (opzionale)
            <input id="advScopes" class="mt-1 w-full bg-white border border-slateLine rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-sky-200" placeholder="https://www.googleapis.com/auth/gmail.readonly" />
          </label>
        </div>
        <div class="text-xs opacity-70">Origin consigliata (GitHub Pages): <code id="originsHint"></code></div>
        <div class="flex flex-wrap gap-2 justify-end">
          <button id="advTest"  class="btn btn-primary">Test accesso</button>
          <button id="advSave"  class="btn btn-positive">Salva</button>
          <button id="advReset" class="btn btn-negative">Reset LocalStorage</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Report IA -->
  <div id="aiReportModal" class="overlay" aria-modal="true" role="dialog">
    <div class="glass rounded-2xl p-0 w-[min(860px,96vw)] max-h-[92svh] overflow-auto animate-slide">
      <div class="p-4 border-b border-[#E5E7EB] flex items-center justify-between">
        <div class="text-lg font-medium" id="aiReportTitle">Report IA</div>
        <div class="flex items-center gap-2">
          <button id="btnReportDownloadTxt" class="btn text-xs">Scarica TXT</button>
          <button id="aiReportClose" class="btn" aria-label="Chiudi report IA">Chiudi</button>
        </div>
      </div>
      <div class="grid md:grid-cols-2 gap-0">
        <div class="p-4 space-y-3">
          <div id="aiReportKpi" class="grid grid-cols-2 gap-2 print-kpis"></div>
          <div class="space-y-2">
            <div class="text-sm opacity-70">Trend ultime 24h</div>
            <div id="aiReportChart" class="w-full h-40 bg-slate-100 rounded-lg overflow-hidden grid place-items-center">
              <div class="text-xs opacity-60">Nessun dato</div>
            </div>
          </div>
          <div>
            <div class="text-sm opacity-70 mb-1">Heatmap celle</div>
            <div id="aiReportHeatmap" class="flex flex-wrap gap-1"></div>
          </div>
        </div>
        <div class="p-4 border-t md:border-t-0 md:border-l border-[#E5E7EB]">
          <div class="text-sm opacity-70 mb-2">Mini chat IA (ultimi allarmi)</div>
          <div id="aiReportList" class="space-y-3 max-h-[50vh] overflow-auto pr-2">
            <!-- bubble skeletons -->
            <div class="bubble"><div class="avatar">ü§ñ</div><div class="msg skeleton h-10 w-full"></div></div>
            <div class="bubble"><div class="avatar">ü§ñ</div><div class="msg skeleton h-10 w-5/6"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dettaglio riga -->
  <div id="rowModal" class="overlay" aria-modal="true" role="dialog">
    <div id="rowModalBody" class="glass rounded-2xl p-6 w-[min(720px,96vw)] max-h-[92svh] overflow-auto animate-slide"></div>
  </div>

  <!-- ========== APP SCRIPT ========== -->
<script>
/* ===================== CONFIG / STATE ===================== */
const APP_VERSION = 6;

const DEFAULTS = {
  CLIENT_ID: "882609618607-c0e975cg1ughd4bi76hnee58c2ka6h2m.apps.googleusercontent.com",
  API_KEY: "",
  SCOPES: "https://www.googleapis.com/auth/gmail.readonly",
  GMAIL_QUERY: "newer_than:30d (subject:(temperatura) OR subject:(allarme) OR subject:(temperature))",
  TEMP_RX: "(-?\\d+(?:[\\.,]\\d+)?)\\s*(?:¬∞\\s*[Cc]|gradi)",
  LOGIN_HINT: "resinellialimentari@gmail.com",
  LOGO_URL: "",
  ICON_URL: "",
  DEV_LOGO_URL: "",
  GMAIL_POLL_MS: 45000
};

const DEFAULT_FILIALI = [
  { id:'castione', name:'Resinelli Castione', email:'allarmi@edilrepairs.ch', streamProvider:'jitsi', jitsiDomain:'meet.jit.si', jitsiRoom:'Resinelli-castione', jitsiPass:'', streamUrl:'', streamUser:'', streamPass:'', streamAudio:false, vdoViewId:'', vdoPassword:'' },
  { id:'santantonino', name:"Resinelli Sant'Antonino", email:'allarmi@edilrepairs.ch', streamProvider:'jitsi', jitsiDomain:'meet.jit.si', jitsiRoom:'Resinelli-santantonino', jitsiPass:'', streamUrl:'', streamUser:'', streamPass:'', streamAudio:false, vdoViewId:'', vdoPassword:'' },
  { id:'losone', name:'Resinelli Losone', email:'allarmi@edilrepairs.ch', streamProvider:'jitsi', jitsiDomain:'meet.jit.si', jitsiRoom:'Resinelli-losone', jitsiPass:'', streamUrl:'', streamUser:'', streamPass:'', streamAudio:false, vdoViewId:'', vdoPassword:'' }
];

/* Stato: aggiunti filialeNames + oauth (token persistito) + gmailLastSync */
let state = { username: '', filiali: [], history: {}, version: APP_VERSION, filialeNames: {}, oauth: null, gmailLastSync: null };
let cfg = { ...DEFAULTS };
let tokenClient = null;
let gmailPollHandle = null;
let currentRange = '24h';
let histSearchTerm = '';
let histStatus = 'all';
let histSort = 'date_desc';

/* ===================== UTIL ===================== */
const $ = (sel)=> document.querySelector(sel);
function el(html){ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstElementChild }
function fmtDate(d){ try{ return new Intl.DateTimeFormat('it-CH',{dateStyle:'medium', timeStyle:'short'}).format(d) }catch{ return new Date(d).toLocaleString() } }
function fmtHHmm(ts){ const d=new Date(ts); const p=(n)=>String(n).padStart(2,'0'); return `${p(d.getHours())}:${p(d.getMinutes())}`; }
function toNumber(str){ return parseFloat(String(str).replace(',', '.')) }
function normalizeText(s){ return (s||'').replace(/[‚Äì‚Äî‚àí]/g,'-').replace(/\s+/g,' ').trim(); }
function statusCellKey(subject){ const m=(subject||'').match(/Allarme temperatura:\s*([^\(]+)\s*\(([^\)]+)\)/i); return m? normalizeText(m[1]).toLowerCase() : normalizeText(subject||'').toLowerCase(); }
function copyTxt(t){ try{ navigator.clipboard.writeText(t||''); }catch{} }
function downloadFile(filename, content, mime='text/plain'){
  const blob = new Blob([content], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function setStatus(msg){ const elBox=$('#statusBox'); if(elBox) elBox.textContent = msg || ""; }
function showError(msg){ const elBox=$('#errorBox'); if(elBox) elBox.textContent = msg || ""; }

/* ===================== HELPER MAPPING FILIALE ROBUSTO ===================== */
function stripAccents(s){ return s.normalize('NFD').replace(/[\u0300-\u036f]/g,''); }
function normName(s){
  return stripAccents((s||'').toLowerCase().replace(/\s+/g,' ').trim());
}
function findFilialeIdFromText(nameHint, fullLowText){
  const text = normName(fullLowText||'');
  const byExact = (state.filiali||[]).find(f => normName(f.name) === normName(nameHint||''));
  if (byExact) return byExact.id;
  const byStart = (state.filiali||[]).find(f => normName(f.name).startsWith(normName(nameHint||'')));
  if (byStart) return byStart.id;
  const byInclude = (state.filiali||[]).find(f => text.includes(normName(f.name)));
  if (byInclude) return byInclude.id;
  return null;
}

/* ===================== STORAGE ===================== */
function migrateIfNeeded(s){ return s; }
function loadState(){
  try{
    const raw = localStorage.getItem('resinelli_monitor');
    if (raw){
      const s = migrateIfNeeded(JSON.parse(raw));
      state.username = s.username || '';
      state.filiali = Array.isArray(s.filiali) && s.filiali.length ? s.filiali : JSON.parse(JSON.stringify(DEFAULT_FILIALI));
      state.history = s.history || {};
      state.version = s.version || APP_VERSION;
      state.filialeNames = s.filialeNames || Object.fromEntries((state.filiali||[]).map(f => [f.id, f.name]));
      state.oauth = s.oauth || null;
      state.gmailLastSync = s.gmailLastSync || null;  // AGGIUNTO
      cfg = { ...DEFAULTS, ...(s.cfg||{}) };
    } else {
      state.filiali = JSON.parse(JSON.stringify(DEFAULT_FILIALI));
      state.filialeNames = Object.fromEntries((state.filiali||[]).map(f => [f.id, f.name]));
    }
  }catch(e){ console.warn('Storage load error', e); }
  applyBranding();
}
function saveState(){
  try { localStorage.setItem('resinelli_monitor', JSON.stringify({ ...state, cfg })); } catch(e){ console.warn('Storage save error', e); }
}

/* ===================== GMAIL ===================== */
const gmailService = {
  isConnected(){
    try{ const token = window.gapi?.client?.getToken?.(); return !!(token && token.access_token); } catch{ return false; }
  },
  async fetchEmails(){ try{ if (!this.isConnected()) return; await fetchAlarms(); }catch(e){ console.error('fetchEmails', e); throw e; } }
};

async function waitForGapiLoad(maxMs=10000){
  const t0 = Date.now();
  while (!(window.gapi && window.gapi.load)) { if (Date.now()-t0 > maxMs) throw new Error("gapi non caricato"); await new Promise(r=>setTimeout(r,50)); }
}

// PATCH: wait for GIS
async function waitForGISLoad(maxMs=10000){
  const t0 = Date.now();
  while (!(window.google?.accounts?.oauth2)) {
    if (Date.now()-t0 > maxMs) throw new Error("GIS non caricato");
    await new Promise(r=>setTimeout(r,50));
  }
}
async function initGapi(){
  await waitForGapiLoad();
  return new Promise((resolve, reject)=>{
    try{
      window.gapi.load('client', async ()=>{
        try{
          const opts = { discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest"] };
          if (cfg.API_KEY) opts.apiKey = cfg.API_KEY;
          await window.gapi.client.init(opts);
          resolve();
        }catch(e){ reject(e); }
      });
    }catch(e){ reject(e); }
  });
}

/* ======= Persistenza token GIS: helpers ======= */
function setAccessTokenFromResp(resp){
  const at = resp?.access_token;
  if (!at) return;
  window.gapi?.client?.setToken?.({ access_token: at });
  state.oauth = {
    access_token: at,
    expires_at: Date.now() + ((resp.expires_in || 3600) - 60)*1000 // rinnovo 1 min prima
  };
  saveState();
}
function isTokenValid(){
  return !!state?.oauth?.access_token && Date.now() < (state.oauth.expires_at||0);
}
async function ensureToken(){
  try{
    if (isTokenValid()){
      if (!gmailService.isConnected()) {
        window.gapi?.client?.setToken?.({ access_token: state.oauth.access_token });
      }
      return;
    }
    // Token non valido ‚Üí prova silent refresh, MAI aprire popup qui
    await trySilentRefresh();
  }catch(e){ /* silente */ }
}
function startTokenAutoRefresh(){
  setInterval(async ()=>{
    const msLeft = (state?.oauth?.expires_at||0) - Date.now();
    if (!state?.oauth?.access_token || msLeft < 2*60*1000){
      try { await trySilentRefresh(); } catch(_){}
    }
  }, 60*1000);
}

/* ======= Silent refresh no-popup & backoff ======= */
let lastSilentTry = 0;
let silentBackoffMs = 0;

async function trySilentRefresh(){
  // Evita tentativi troppo ravvicinati o in background tab
  if (document.visibilityState !== 'visible') return false;
  const now = Date.now();
  if (now - lastSilentTry < Math.max(15000, silentBackoffMs)) return false;

  lastSilentTry = now;
  try{
    if (!tokenClient) await initGIS();
    await new Promise((resolve, reject)=>{
      tokenClient.callback = (r)=> r?.access_token ? resolve(r) : reject(r);
      tokenClient.requestAccessToken({ prompt: '', hint: cfg.LOGIN_HINT || '' });
    });
    // Successo ‚Üí reset backoff
    silentBackoffMs = 0;
    updateGmailStatusUI();
    return true;
  }catch(e){
    // Fallito ‚Üí aumenta backoff, non mostrare popup
    silentBackoffMs = Math.min(5*60*1000, (silentBackoffMs||10000)*1.7);
    return false;
  }
}

// PATCH: async initGIS, waits for GIS to be ready
async function initGIS(){
  if (tokenClient) return tokenClient;
  await waitForGISLoad(20000);
  if (!cfg?.CLIENT_ID || !cfg.CLIENT_ID.endsWith('.apps.googleusercontent.com')) {
    alert('Devi impostare il Google OAuth CLIENT_ID.');
    window.openAdvancedModal?.();
    throw new Error('CLIENT_ID mancante');
  }
  tokenClient = window.google.accounts.oauth2.initTokenClient({
    client_id: cfg.CLIENT_ID,
    scope: (cfg?.SCOPES || DEFAULTS.SCOPES),
    hint: cfg.LOGIN_HINT || undefined,
    callback: (resp)=>{
      if (resp?.access_token){
        window.gapi?.client?.setToken?.({ access_token: resp.access_token });
        setAccessTokenFromResp(resp);
        updateGmailStatusUI();
      }
    }
  });
  return tokenClient;
}

async function signIn(prompt=''){
  return new Promise(async (resolve, reject)=>{
    try{
      if (!tokenClient) { try { await initGIS(); } catch(e){ return reject(e); } }
      tokenClient.callback=(r)=> r?.access_token? resolve(r): reject(r);
      tokenClient.requestAccessToken({ prompt, hint: cfg.LOGIN_HINT || '' });
    }catch(e){ reject(e);}
  });
}

// AGGIUNGI: signOut usata dal bottone "Test accesso"
async function signOut(){
  try{
    const tk = window.gapi?.client?.getToken?.();
    if (tk?.access_token && window.google?.accounts?.oauth2){
      window.google.accounts.oauth2.revoke(tk.access_token, ()=>{});
      window.gapi.client.setToken(null);
      state.oauth = null;
      saveState();
      updateGmailStatusUI();
    }
  }catch(e){ console.warn('signOut', e); }
}

async function trySilentSignIn(){
  try{
    if (!window.gapi?.client) await initGapi();
    if (!tokenClient) await initGIS();
    return await signIn('');
  }catch{ return null; }
}

// AGGIUNGI: updateGmailStatusUI usata da vari punti
function updateGmailStatusUI(){
  const text = $("#gmail-status-text");
  const dot  = document.querySelector(".gmail-status .dot");
  const last = $("#gmailLastSync");

  const connected = gmailService.isConnected();

  if (text) text.textContent = connected ? "Gmail connesso" : "Gmail non connesso";
  if (dot)  dot.style.backgroundColor = connected ? "#10b981" : "#94a3b8";

  if ($('#quickStats')) {
    $('#quickStats').textContent = connected
      ? 'Sincronizzazione attiva. Sto monitorando gli allarmi‚Ä¶'
      : 'Accedi a Gmail per sincronizzare gli allarmi.';
  }

  if (last) {
    last.textContent = state.gmailLastSync
      ? `Ultimo aggiornamento: ${fmtDate(new Date(state.gmailLastSync))}`
      : '';
  }
}

async function gmailTick(){
  const sp = $('#gmailSpinner'); if (sp) sp.style.display='inline-block';
  try{
    await ensureToken();
    if (gmailService.isConnected()) {
      await gmailService.fetchEmails();
      state.gmailLastSync = Date.now();
      saveState();
    }
    updateGmailStatusUI();
  }catch(e){
    // Se semplicemente non siamo loggati, non mostrare "errore"
    if (gmailService.isConnected()){
      const text = $("#gmail-status-text"); if (text) text.textContent = "Gmail: errore";
      console.error('gmailTick', e);
    }
  } finally { if (sp) sp.style.display='none'; }
}

/* Gmail API helpers */
async function listMessages(q, max=300){
  const g = window.gapi?.client?.gmail;
  if (!g) return [];
  let msgs=[], pageToken, rounds=0;
  do{
    const res=await g.users.messages.list({userId:'me', q, maxResults:100, pageToken});
    const d=res.result;
    if(d.messages) msgs.push(...d.messages);
    pageToken=d.nextPageToken;
    rounds++;
  } while(pageToken && msgs.length<max && rounds<10);
  return msgs;
}
async function getMessage(id){ const g=window.gapi?.client?.gmail; if(!g) return {}; const res=await g.users.messages.get({userId:'me', id, format:'full'}); return res.result; }
function decodeBody(body){ try{ return decodeURIComponent(escape(window.atob((body||'').replace(/-/g,'+').replace(/_/g,'/')))); }catch{ return '' } }
function getHeader(msg, name){ const h=(msg?.payload?.headers||[]).find(h=> h.name?.toLowerCase()===name.toLowerCase()); return h? h.value:''; }

function parseTemperatures(subject, body){
  const s = normalizeText(subject); const b = normalizeText(body);
  const rxNear = /(-?\d+(?:[.,]\d+)?)(?=\s*(?:¬∞\s*[Cc]|gradi))/i;
  const mTemp = b.match(/temperatura[^.\n\r]*?\b(?:√®\s*di|di)\s*(-?\d+(?:[.,]\d+)?)/i) || s.match(/temperatura[^.\n\r]*?\b(?:√®\s*di|di)\s*(-?\d+(?:[.,]\d+)?)/i) || b.match(rxNear);
  const mRange = b.match(/\b(dovrebbe|range|limiti?)\b[^.\n\r]*?\bda\s*(-?\d+(?:[.,]\d+)?)\s*a\s*(-?\d+(?:[.,]\d+)?)/i);
  let temp = mTemp ? toNumber(mTemp[1] || mTemp[0]) : NaN;
  const min = mRange ? toNumber(mRange[2]) : NaN;
  const max = mRange ? toNumber(mRange[3]) : NaN;
  if(!isFinite(temp)){
    const all = [...b.matchAll(/-?\d+(?:[.,]\d+)?/g)].map(m=>({v:toNumber(m[0]), i:m.index}));
    if (mRange) {
      const rs = mRange.index, re = rs + mRange[0].length;
      const candidates = all.filter(n => n.i < rs || n.i > re);
      if (candidates.length) temp = candidates[0].v;
    } else if (all.length){ temp = all[0].v; }
  }
  return { temp, min, max };
}
function inferStatusSmart(subject, body){
  const txt = (subject + '\n' + body).toLowerCase();
  const saysAlarm   = /(allarme|alert|warning|alto|high|critical|critico)/.test(txt);
  const saysRestore = /(ripristin|rientrat|tornat|normalizzat|ritornat|ok|risolt|cleared|resolved)/.test(txt) && /temperatura|temp/.test(txt);
  if(saysRestore && !saysAlarm) return 'ok';
  if(saysAlarm) return 'alto';
  return null;
}
function extractCellAndFiliale(subject){
  const m = (subject||'').match(/Allarme temperatura:\s*([^\(]+)\s*\(([^\)]+)\)/i);
  if(m) return { cella: m[1].trim(), filiale: m[2].trim() };
  return { cella: subject||'', filiale: '' };
}

/* Range helpers */
function getCutoff(range){
  const now = Date.now();
  if (range==='24h') return now - 24*3600*1000;
  if (range==='7d')  return now - 7*24*3600*1000;
  if (range==='30d') return now - 30*24*3600*1000;
  return 0;
}
function filterRowsByRange(rows, range){
  const cut = getCutoff(range);
  return (rows||[]).filter(r => (range==='all') ? true : r.date >= cut);
}

async function fetchAlarms(){
  const q = cfg.GMAIL_QUERY;
  const msgs = await listMessages(q, 600);   // elenco "vero" attuale
  const newHistory = {};                     // nuovo storico ricostruito

  function findFilialeByEmailHeaders(toHdr, deliv, fromHdr){
    const to=(toHdr||'').toLowerCase(), del=(deliv||'').toLowerCase(), from=(fromHdr||'').toLowerCase();
    for (const f of (state.filiali||[])) {
      const mail=(f.email||'').toLowerCase().trim();
      if (!mail) continue;
      if (to.includes(mail) || del.includes(mail) || from.includes(mail)) return f.id;
    }
    return null;
  }

  for(const m of (msgs||[])){
    const msg = await getMessage(m.id);
    if (!msg || !msg.payload) continue;

    const subject = getHeader(msg,'Subject')||'(senza oggetto)';
    const d = new Date(Number(msg.internalDate||Date.now()));

    // estrai body (testo semplice se disponibile, altrimenti html ripulito)
    let body=''; (function extract(part){
      if(!part) return;
      if(part.mimeType==='text/plain' && part.body?.data){ body += decodeBody(part.body.data) + '\n'; }
      if(part.parts) part.parts.forEach(extract);
      if(part.mimeType==='text/html' && !body && part.body?.data){ body = decodeBody(part.body.data).replace(/<[^>]+>/g,' '); }
    })(msg.payload);

    // stato + temperature
    let status = inferStatusSmart(subject, body);
    const { temp, min, max } = parseTemperatures(subject, body);
    if(status==='alto' && isFinite(temp) && isFinite(min) && isFinite(max) && min <= temp && temp <= max){ status = 'ok'; }
    if(!status) continue; // ignora mail non riconosciute

    // deduzione filiale (priorit√†: subject ‚Üí email ‚Üí testo ‚Üí selezione corrente)
    const { filiale: filialeName, cella } = extractCellAndFiliale(subject);
    const fid = (function(){
      let id = findFilialeIdFromText(filialeName, subject + '\n' + body);
      if (id) return id;
      const id2 = findFilialeByEmailHeaders(getHeader(msg,'To'), getHeader(msg,'Delivered-To'), getHeader(msg,'From'));
      if (id2) return id2;
      id = findFilialeIdFromText('', subject + '\n' + body);
      if (id) return id;
      return $('#filialeSelect')?.value || null; // ultimo fallback
    })();
    if (!fid) continue;

    if (filialeName) state.filialeNames[fid] = filialeName;

    const displayName =
      (state.filiali.find(x=>x.id===fid)?.name) ||
      filialeName ||
      state.filialeNames[fid] ||
      fid;

    const row = {
      id: m.id,
      date: +d,
      temp, min, max,
      status, subject,
      bodyPlain: body,
      cellKey: normalizeText(cella).toLowerCase(),
      fid,
      displayName,
      messageId: getHeader(msg, 'Message-Id') || ''
    };

    (newHistory[fid] ||= []);
    if(!newHistory[fid].some(r=>r.id===row.id)) newHistory[fid].push(row);
  }

  // ordina e limita
  for(const fid of Object.keys(newHistory)){
    newHistory[fid] = newHistory[fid].sort((a,b)=>a.date-b.date).slice(-2000);
  }

  // üî• HARD SYNC: sostituisce lo storico con quello appena ricostruito
  state.history = newHistory;
  saveState();
  refreshUIAfterData();
}

/* ===================== LIVE ===================== */
let webrtcSession = null;
let jitsiApi = null;

function cleanupWebRTC(){
  try{
    if(webrtcSession?.pc){
      webrtcSession.pc.getTransceivers?.().forEach(t=>t.stop?.());
      webrtcSession.pc.getSenders?.().forEach(s=>s.track?.stop?.());
      webrtcSession.pc.getReceivers?.().forEach(r=>r.track?.stop?.());
      webrtcSession.pc.close?.();
    }
  }catch{}
  webrtcSession = null;
}
async function stopWhepResource(){ if(webrtcSession?.resourceUrl){ try{ await fetch(webrtcSession.resourceUrl, { method:'DELETE', mode:'cors', headers: webrtcSession.authHeaders || {} }); }catch{} } }
function destroyJitsi(){ try{ jitsiApi?.dispose?.(); }catch{} jitsiApi = null; }

function startJitsi(f) {
  destroyJitsi();
  const box = $('#jitsiContainer');
  const frame = $('#liveFrame');
  const vid = $('#webrtcVideo');
  const none = $('#noStream');
  if (!box || !frame || !vid || !none) return;

  if (!f.jitsiDomain || !f.jitsiRoom || typeof window.JitsiMeetExternalAPI === 'undefined') {
    none.classList.remove('hidden'); box.classList.add('hidden'); frame.classList.add('hidden'); vid.classList.add('hidden');
    showError(!window.JitsiMeetExternalAPI ? 'API Jitsi non caricata.' : 'Config Jitsi incompleta (domain/room).');
    $('#statusBox') && ($('#statusBox').textContent = 'Jitsi non disponibile su questo dispositivo o rete.');
    return;
  }
  none.classList.add('hidden'); frame.classList.add('hidden'); vid.classList.add('hidden'); box.classList.remove('hidden');

  const domain = f.jitsiDomain || 'meet.jit.si';
  const options = {
    roomName: f.jitsiRoom,
    parentNode: box,
    width: '100%', height: '100%',
    configOverwrite: { prejoinPageEnabled: false, disableDeepLinking: true, startWithAudioMuted: true, startWithVideoMuted: true },
    interfaceConfigOverwrite: { TOOLBAR_BUTTONS: ['microphone','camera','desktop','fullscreen','hangup'] },
    userInfo: { displayName: state.username || 'Viewer' }
  };
  try{
    jitsiApi = new window.JitsiMeetExternalAPI(domain, options);
    if (f.jitsiPass) {
      jitsiApi.addListener?.('videoConferenceJoined', () => jitsiApi.executeCommand?.('password', f.jitsiPass));
      jitsiApi.addListener?.('passwordRequired',      () => jitsiApi.executeCommand?.('password', f.jitsiPass));
    }
  }catch(e){
    showError('Errore init Jitsi: ' + (e?.message || e));
    box.classList.add('hidden'); none.classList.remove('hidden');
  }
}
function buildVdoViewUrl(id, pwd, label, rawUrl){
  if (rawUrl && /vdo\.ninja/.test(rawUrl)) {
    const u = new URL(rawUrl);
    u.searchParams.set('cleanoutput','1'); u.searchParams.set('autostart','1'); u.searchParams.set('embed','1');
    if (label) u.searchParams.set('label', label);
    return u.toString();
  }
  const p = new URLSearchParams();
  if (id)  p.set('view', id);
  if (pwd) { p.set('password', pwd); p.set('p', pwd); }
  p.set('cleanoutput','1'); p.set('autostart','1'); p.set('embed','1');
  if (label) p.set('label', label);
  return `https://vdo.ninja/?${p.toString()}`;
}
function startVdo(f){
  destroyJitsi();
  const box = $('#jitsiContainer');
  const frame = $('#liveFrame');
  const vid = $('#webrtcVideo');
  const none = $('#noStream');
  if (!box || !frame || !vid || !none) return;

  if (!f.vdoViewId && !/vdo\.ninja/.test(f.streamUrl||'')) {
    showError('VDO.Ninja: View ID mancante.');
    frame.classList.add('hidden'); box.classList.add('hidden'); vid.classList.add('hidden'); none.classList.remove('hidden');
    return;
  }
  const url = buildVdoViewUrl(f.vdoViewId || '', f.vdoPassword || '', f.name || 'Live', f.streamUrl);
  frame.src = url;
  frame.classList.remove('hidden'); box.classList.add('hidden'); vid.classList.add('hidden'); none.classList.add('hidden');
}
async function startWhep(){
  const none = $('#noStream');
  if (none) { none.classList.remove('hidden'); }
  setStatus('WHEP non configurato');
  showError('WHEP disabilitato (usa Jitsi o VDO.Ninja).');
}

function updateLiveToolbar(){
  const fsel = $('#filialeSelect'); if (!fsel) return;
  const f = (state.filiali||[]).find(x=>x.id === fsel.value);
  if(!f){ if($('#liveProvider')) $('#liveProvider').textContent='‚Äî'; if($('#liveSid')) $('#liveSid').textContent='‚Äî'; if($('#livePwd')) $('#livePwd').textContent='‚Äî'; return; }
  if (f.streamProvider === 'jitsi'){
    $('#liveProvider') && ($('#liveProvider').textContent = 'Jitsi');
    $('#liveSid') && ($('#liveSid').textContent = f.jitsiRoom || '‚Äî');
    $('#livePwd') && ($('#livePwd').textContent = f.jitsiPass || '‚Äî');
  } else if (f.streamProvider === 'vdo'){
    $('#liveProvider') && ($('#liveProvider').textContent = 'VDO.Ninja');
    $('#liveSid') && ($('#liveSid').textContent = f.vdoViewId || '‚Äî');
    $('#livePwd') && ($('#livePwd').textContent = f.vdoPassword || '‚Äî');
  } else {
    $('#liveProvider') && ($('#liveProvider').textContent = 'WHEP/Worker');
    $('#liveSid') && ($('#liveSid').textContent = f.streamUser || '‚Äî');
    $('#livePwd') && ($('#livePwd').textContent = f.streamPass || '‚Äî');
  }
}
function openOnProvider(f) {
  if (!f) return;
  if (f.streamProvider === 'jitsi') {
    const url = `https://${f.jitsiDomain||'meet.jit.si'}/${encodeURIComponent(f.jitsiRoom||'')}`;
    window.open(url, '_blank', 'noopener,noreferrer');
  } else if (f.streamProvider === 'vdo') {
    const url = buildVdoViewUrl(f.vdoViewId||'', f.vdoPassword||'', f.name||'Live', f.streamUrl);
    window.open(url, '_blank', 'noopener,noreferrer');
  } else if (f.streamUrl) {
    window.open(f.streamUrl, '_blank', 'noopener,noreferrer');
  }
}
async function startLiveForCurrent(){
  const frame = $('#liveFrame'); const video = $('#webrtcVideo'); const none = $('#noStream');
  const jitsiBox = $('#jitsiContainer');
  if (frame) frame.classList.add('hidden');
  if (video) video.classList.add('hidden');
  if (none)  none.classList.remove('hidden');
  if (jitsiBox) jitsiBox.classList.add('hidden');
  setStatus(''); showError('');
  await stopWhepResource(); cleanupWebRTC(); destroyJitsi();

  const fsel = $('#filialeSelect'); const fid = fsel?.value;
  const f = (state.filiali||[]).find(x=>x.id === fid);
  if(!f){ showError('Nessuna filiale selezionata.'); return; }
  updateLiveToolbar();

  if (f.streamProvider === 'vdo'){ startVdo(f); setStatus('VDO.Ninja'); return; }
  if (f.streamProvider === 'jitsi'){ startJitsi(f); setStatus('Jitsi Meet'); return; }
  startWhep();
}

/* ===================== 24h STATS ===================== */
function build24hStats(stateObj){
  let totAllarmi24h = 0, risolti24h = 0, attivi = 0;
  const filialiSet = new Set(), celleSet = new Set();
  let lastEventTs = null;

  const cellStatus = {};
  for(const fid of Object.keys(stateObj.history||{})){
    const rows = filterRowsByRange(stateObj.history[fid]||[], '24h').sort((a,b)=>a.date-b.date);
    if (!rows.length) continue;
    filialiSet.add(fid);
    for(const r of rows){
      const cell = r.cellKey || statusCellKey(r.subject);
      celleSet.add(cell);
      (cellStatus[fid] ||= {}); (cellStatus[fid][cell] ||= []).push(r);
      if (r.status === 'alto') { totAllarmi24h++; lastEventTs = Math.max(lastEventTs||0, r.date); }
    }
  }
  for(const fid of Object.keys(cellStatus)){
    for(const cell of Object.keys(cellStatus[fid])){
      const events = cellStatus[fid][cell];
      let open = false;
      for(const e of events){
        if (e.status==='alto' && !open) open=true;
        else if (open && e.status==='ok'){ risolti24h++; open=false; }
      }
      if (open) attivi++;
    }
  }
  return { attivi, totAllarmi24h, risolti24h, filialiCoinvolte: filialiSet.size, celleCoinvolte: celleSet.size, lastEventTs };
}
function renderHomeStats24h(){
  const routeHome = $('#route-home'); if (!routeHome) return;
  let panel = $('#homeStats24h');
  if (!panel) {
    panel = el(`<section id="homeStats24h" class="glass rounded-2xl p-5 space-y-3 mb-4"></section>`);
    routeHome.insertBefore(panel, routeHome.firstChild);
  }
  const s = build24hStats(state);
  panel.innerHTML = `
    <div class="font-medium tracking-wide mb-2">Statistiche ultime 24 ore</div>
    <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-5 gap-2">
      <div class="p-3 rounded-lg bg-white border border-[#E5E7EB]">
        <div class="text-xs opacity-70">Allarmi attivi</div>
        <div class="text-xl font-semibold text-rose-600">${s.attivi}</div>
      </div>
      <div class="p-3 rounded-lg bg-white border border-[#E5E7EB]">
        <div class="text-xs opacity-70">Totale allarmi (24h)</div>
        <div class="text-xl font-semibold text-rose-600">${s.totAllarmi24h}</div>
      </div>
      <div class="p-3 rounded-lg bg-white border border-[#E5E7EB]">
        <div class="text-xs opacity-70">Allarmi risolti (24h)</div>
        <div class="text-xl font-semibold text-emerald-600">${s.risolti24h}</div>
      </div>
      <div class="p-3 rounded-lg bg-white border border-[#E5E7EB]">
        <div class="text-xs opacity-70">Filiali coinvolte (24h)</div>
        <div class="text-xl font-semibold">${s.filialiCoinvolte}</div>
      </div>
      <div class="p-3 rounded-lg bg-white border border-[#E5E7EB]">
        <div class="text-xs opacity-70">Celle coinvolte (24h)</div>
        <div class="text-xl font-semibold">${s.celleCoinvolte}</div>
      </div>
    </div>
    <div class="mt-2 text-xs opacity-70">Ultimo evento: <span class="font-semibold">${s.lastEventTs ? fmtDate(new Date(s.lastEventTs)) : '‚Äî'}</span></div>
  `;
  // Quick KPI in sidebar
  $('#kAttivi') && ($('#kAttivi').textContent = s.attivi);
  $('#kRisolti') && ($('#kRisolti').textContent = s.risolti24h);
}

/* ===================== IA REPORT (mini chat) ===================== */
function buildIAChatMessages(fid=null){
  const filiali = fid ? [fid] : Object.keys(state.history||{});
  const msgs = [];
  for(const fId of filiali){
    const fil = (state.filiali||[]).find(x=>x.id===fId);
    const filName = fil?.name || state.filialeNames[fId] || fId;
    const rows = filterRowsByRange(state.history[fId]||[], '24h').sort((a,b)=>a.date-b.date);
    if (!rows.length) continue;
    const cells = {};
    for(const r of rows){
      const cell = r.cellKey || statusCellKey(r.subject);
      (cells[cell] ||= []).push(r);
    }
    for(const cell of Object.keys(cells)){
      const events = cells[cell];
      let openStart = null;
      events.forEach((ev)=>{
        if (ev.status==='alto' && openStart==null) openStart = ev.date;
        if (openStart!=null && ev.status==='ok'){
          const t1 = fmtHHmm(openStart), t2 = fmtHHmm(ev.date);
          msgs.push(`Tra le ${t1} e le ${t2} si √® registrata una temperatura sopra i limiti nella cella ‚Äú${cell}‚Äù a ${filName}; allarme rientrato.`);
          openStart = null;
        }
      });
      if (openStart!=null){
        const t1 = fmtHHmm(openStart);
        msgs.push(`Allarme ancora attivo dalla ${t1} nella cella ‚Äú${cell}‚Äù a ${filName}.`);
      }
    }
  }
  if (!msgs.length) msgs.push('Nessun allarme nelle ultime 24 ore.');
  return msgs;
}
function renderIAChat(fid=null, filialeName=null){
  const list = $('#aiReportList'); if (!list) return;
  list.innerHTML='';
  const msgs = buildIAChatMessages(fid);
  msgs.forEach(m=>{
    list.appendChild(el(`
      <div class="bubble">
        <div class="avatar" aria-hidden="true">ü§ñ</div>
        <div class="msg">${m}</div>
      </div>
    `));
  });
}

/* ===================== openAIReport ===================== */
function openAIReport(fid=null, filialeName=null){
  const title = fid ? `Report IA ‚Äî ${filialeName||fid} ‚Äî ultime 24 ore` : `Report IA ‚Äî Globale ‚Äî ultime 24 ore`;
  $('#aiReportTitle') && ($('#aiReportTitle').textContent = title);

  // KPI & heat
  const rowsByFil = fid ? [[fid, state.history[fid]||[]]] : Object.entries(state.history||{});
  let totAllarmi24h = 0, risolti24h = 0, attivi = 0;
  const filialiSet = new Set(), celleSet = new Set();
  const cellStatus = {};
  const heat = new Map();

  for (const [k, rows] of rowsByFil){
    const filteredRows = filterRowsByRange(rows||[], '24h').sort((a,b)=>a.date-b.date);
    if (!filteredRows.length) continue;
    filialiSet.add(k);
    for(const r of filteredRows){
      const cell = r.cellKey || statusCellKey(r.subject);
      celleSet.add(cell);
      (cellStatus[k] ||= {}); (cellStatus[k][cell] ||= []).push(r);
      if (r.status === 'alto') totAllarmi24h++;
      const prev = heat.get(cell) || false; heat.set(cell, r.status==='alto' ? true : prev);
    }
  }
  for(const fid2 of Object.keys(cellStatus)){
    for(const cell of Object.keys(cellStatus[fid2])){
      const events = cellStatus[fid2][cell];
      let open = false;
      for(const e of events){
        if (e.status==='alto' && !open) { open=true; }
        else if (open && e.status==='ok'){ risolti24h++; open=false; }
      }
      if (open) attivi++;
    }
  }

  // KPI render
  const kpis = [
    { label:'Eventi (24h)', value: String(totAllarmi24h + risolti24h) },
    { label:'Allarmi attivi stimati', value: String(attivi) },
    { label:'Filiali coinvolte (24h)', value: String(filialiSet.size) },
    { label:'Celle coinvolte (24h)', value: String(celleSet.size) },
    { label:'Allarmi risolti (24h)', value: String(risolti24h) }
  ];
  const kpiBox = $('#aiReportKpi'); if (kpiBox){ kpiBox.innerHTML=''; kpis.forEach(k=>{
    kpiBox.appendChild(el(`<div class="p-3 rounded-lg bg-white border border-[#E5E7EB]">
      <div class="text-xs opacity-70">${k.label}</div>
      <div class="text-xl font-semibold">${k.value}</div>
    </div>`));
  });}

  // Heatmap
  const heatWrap = $('#aiReportHeatmap'); if (heatWrap){
    heatWrap.innerHTML='';
    if (heat.size){
      for(const [cell, isAlarm] of heat.entries()){
        heatWrap.appendChild(el(`<span class="px-2 py-1 text-xs rounded border ${isAlarm? 'bg-rose-50 text-rose-700 border-rose-200':'bg-emerald-50 text-emerald-700 border-emerald-200'}">${cell}</span>`));
      }
    } else {
      heatWrap.appendChild(el('<span class="text-xs opacity-60">Nessuna cella rilevata.</span>'));
    }
  }

  // Mini chat IA
  renderIAChat(fid, filialeName);

  // Chart placeholder (no medie/max)
  const chartWrap = $('#aiReportChart'); if (chartWrap){ chartWrap.innerHTML='<div class="text-xs opacity-60">Nessun dato</div>'; }

  // Download TXT
  $('#btnReportDownloadTxt') && ($('#btnReportDownloadTxt').onclick = ()=>{
    const lines = [];
    lines.push(title);
    kpis.forEach(k=> lines.push(`${k.label}: ${k.value}`));
    lines.push('');
    lines.push('Mini chat IA (sintesi):');
    buildIAChatMessages(fid).forEach(m=>lines.push('- ' + m));
    downloadFile(`report_${fid||'globale'}_${new Date().toISOString().slice(0,10)}.txt`, lines.join('\n'), 'text/plain;charset=utf-8;');
  });

  // Apri modal
  const modal = $('#aiReportModal'); modal && modal.classList.add('show');
}

/* ===================== ROUTER / NAV ===================== */
const routes = ['home','storico','impostazioni'];
function setActiveTab(hash){
  document.querySelectorAll('.tab-btn').forEach(b=>{
    const r=b.getAttribute('data-route');
    const active = (r===hash);
    b.classList.toggle('bg-blue-50', active);
    b.classList.toggle('border-blue-200', active);
    b.classList.toggle('font-semibold', active);
  });
}
function go(route){
  routes.forEach(r => $('#route-'+r)?.classList.toggle('hidden', r!==route));
  $('#pageTitle') && ($('#pageTitle').textContent = route.charAt(0).toUpperCase()+route.slice(1));
  setActiveTab('#'+route);
  if(route==='storico') renderStorico();
  if(route==='home'){
    checkFilialiStatus();
    runCheckFiliali();
       uiRenderFilialiDesc();
    uiBindLiveSizer();
    renderHomeStats24h();
  }
  if(route==='impostazioni') renderImpostazioni();
  history.replaceState?.(null, '', '#'+route);
}
window.addEventListener('hashchange', ()=>{ const r=(location.hash||'#home').slice(1); if(routes.includes(r)) go(r); });

/* ===================== UI HELPERS / REQUIRED FUNZIONI ===================== */
function uiBindLiveSizer(){
  const rng = $('#liveSize'); if (!rng) return;
  const update = ()=>{ document.documentElement.style.setProperty('--live-h', rng.value + 'svh'); };
  update(); rng.addEventListener('input', update);
}
function populateFilialeSelect(){
  const sel = $('#filialeSelect'); if (!sel) return;
  sel.innerHTML = '';
  (state.filiali||[]).forEach(f=>{
    const opt = document.createElement('option'); opt.value = f.id; opt.textContent = f.name; sel.appendChild(opt);
  });
}
function checkFilialiStatus(){
  const bar = $('#statusBar'); const bag = $('#statusBadges');
  if (!bar || !bag) return;
  bag.innerHTML=''; let any=false;
  (state.filiali||[]).forEach(f=>{
    const rows = filterRowsByRange(state.history[f.id]||[], '24h').sort((a,b)=>a.date-b.date);
    if (!rows.length) return;
    const last = rows[rows.length-1];
    const ok = last.status!=='alto';
    any = true;
    bag.appendChild(el(`<span class="badge ${ok?'border-emerald-200 text-emerald-700 bg-emerald-50':'border-rose-200 text-rose-700 bg-rose-50'}">${f.name} ${ok? 'OK':'ALLARME'}</span>`));
  });
  bar.classList.toggle('hidden', !any);
}
function runCheckFiliali(){
  const panel = $('#checkFilialiRows'); if (!panel) return;
  panel.innerHTML='';
  (state.filiali||[]).forEach(f=>{
    const rows = filterRowsByRange(state.history[f.id]||[], '24h').sort((a,b)=>a.date-b.date);
    const last = rows[rows.length-1];
    const status = last ? (last.status==='alto'?'ALLARME':'OK') : '‚Äî';
    const color = last ? (last.status==='alto'?'text-rose-700 bg-rose-50 border-rose-200':'text-emerald-700 bg-emerald-50 border-emerald-200') : 'text-slate-600 bg-slate-50 border-slate-200';
    panel.appendChild(el(`
      <div class="flex items-center justify-between p-2 border rounded-lg ${color}">
        <div class="font-medium">${f.name}</div>
        <div class="text-sm">${status}</div>
      </div>
    `));
  });
}
function uiRenderFilialiDesc(){
  const wrap = $('#filialiDescWrap'); if (!wrap) return;
  wrap.innerHTML='';
  (state.filiali||[]).forEach(f=>{
    const rows = filterRowsByRange(state.history[f.id]||[], '24h').sort((a,b)=>b.date-a.date).slice(0,3);
    const items = rows.map(r=>`<div class="text-xs opacity-70">${fmtDate(new Date(r.date))} ‚Äî ${r.status.toUpperCase()}</div>`).join('') || '<div class="text-xs opacity-50">Nessun evento recente</div>';
    const card = el(`<div class="p-3 border rounded-lg bg-white">
      <div class="flex items-center justify-between">
        <div class="font-medium">${f.name}</div>
        <div class="flex gap-2">
          <button class="btn text-xs" aria-label="Apri report IA ${f.name}" data-fid="${f.id}">Report IA</button>
          <button class="btn text-xs" aria-label="Apri live ${f.name}" data-openlive="${f.id}">Apri live</button>
        </div>
      </div>
      <div class="mt-2">${items}</div>
    </div>`);
    card.querySelector('[data-fid]')?.addEventListener('click', ()=> openAIReport(f.id, f.name));
    card.querySelector('[data-openlive]')?.addEventListener('click', ()=>{ $('#filialeSelect').value = f.id; startLiveForCurrent(); });
    wrap.appendChild(card);
  });
}

/* ===================== STORICO (con nome filiale corretto + funzioni) ===================== */
function applyHistControlsHandlers(){
  $('#histSearch')?.addEventListener('input', (e)=>{ histSearchTerm = (e.target.value||'').toLowerCase(); renderStorico(); });
  $('#histStatus')?.addEventListener('change', (e)=>{ histStatus = e.target.value; renderStorico(); });
  $('#histSort')?.addEventListener('change', (e)=>{ histSort = e.target.value; renderStorico(); });
}
function rowMatches(r){
  const term = histSearchTerm;
  const byText = !term || (r.subject?.toLowerCase().includes(term) || (r.cellKey||'').toLowerCase().includes(term));
  const byStatus = (histStatus==='all') || (r.status===histStatus);
  return byText && byStatus;
}
function sortRows(rows){
  if (histSort==='date_asc') return rows.sort((a,b)=>a.date-b.date);
  return rows.sort((a,b)=>b.date-a.date);
}
function openRowModal(fid, r){
  const body = $('#rowModalBody'); const modal = $('#rowModal');
  if (!body || !modal) return;
  const displayName = (state.filiali||[]).find(x=>x.id===fid)?.name || state.filialeNames[fid] || r.displayName || fid;
  const linkSearch = `https://mail.google.com/mail/u/0/#search/${encodeURIComponent('subject:"'+(r.subject||'')+'"')}`;
  body.innerHTML = `
    <div class="flex items-start justify-between gap-3">
      <div>
        <div class="text-lg font-semibold">${displayName}</div>
        <div class="text-sm opacity-70">${fmtDate(new Date(r.date))}</div>
      </div>
      <button class="btn" id="rowClose" aria-label="Chiudi dettaglio">Chiudi</button>
    </div>
    <div class="mt-3 p-3 border rounded-lg bg-white">
      <div class="text-sm"><b>Stato:</b> ${r.status==='alto'?'<span class="text-rose-700">ALLARME</span>':'<span class="text-emerald-700">OK</span>'}</div>
      <div class="text-sm"><b>Cella:</b> ${r.cellKey || statusCellKey(r.subject)}</div>
      <div class="text-sm"><b>Oggetto:</b> ${r.subject}</div>
      ${Number.isFinite(r.temp)? `<div class="text-sm"><b>Temp rilevata:</b> ${r.temp.toFixed(1)}¬∞C</div>`:''}
      ${(Number.isFinite(r.min)||Number.isFinite(r.max))? `<div class="text-sm"><b>Range atteso:</b> ${Number.isFinite(r.min)?r.min.toFixed(1):'‚Äî'} ‚Äì ${Number.isFinite(r.max)?r.max.toFixed(1):'‚Äî'}</div>`:''}
    </div>
    <div class="mt-3">
      <div class="text-sm opacity-70 mb-1">Corpo email (estratto)</div>
      <pre class="whitespace-pre-wrap text-sm border rounded-lg p-3 bg-white max-h-[40vh] overflow-auto">${(r.bodyPlain||'').trim()||'(vuoto)'}</pre>
    </div>
    <div class="mt-3 flex items-center gap-2">
      <a class="btn btn-primary" href="${linkSearch}" target="_blank" rel="noopener noreferrer">Apri in Gmail</a>
      <button class="btn" id="rowCopy" aria-label="Copia dettagli">Copia dettagli</button>
    </div>
  `;
  body.querySelector('#rowClose')?.addEventListener('click', ()=> modal.classList.remove('show'));
  body.querySelector('#rowCopy')?.addEventListener('click', ()=>{
    const txt = `${displayName}\n${fmtDate(new Date(r.date))}\n${r.status.toUpperCase()} ¬∑ ${r.cellKey}\n${r.subject}\n${(r.bodyPlain||'').trim()}`;
    copyTxt(txt);
  });
  modal.classList.add('show');
}

// MODIFICATO: Storico che itera su state.filiali
function renderStorico(){
  const wrap = $('#storicoWrap'); if (!wrap) return;
  wrap.innerHTML='';
  const range = currentRange;

  // MODIFICATO: usa state.filiali come sorgente di verit√†
  const groups = (state.filiali || []).map(f => {
    const fid = f.id;
    const rowsAll = filterRowsByRange(state.history[fid] || [], range);
    const rows = sortRows(rowsAll.filter(rowMatches));
    const displayName = f.name || state.filialeNames[fid] || fid;
    return { fid, displayName, rows };
  }).sort((a,b)=> a.displayName.localeCompare(b.displayName, 'it'));

  groups.forEach(({fid, displayName, rows})=>{
    const table = el(`<div class="glass rounded-xl p-4">
      <div class="flex items-center justify-between">
        <div class="text-lg font-semibold mb-2">${displayName}</div>
        <div class="text-xs opacity-70">Eventi: ${rows.length}</div>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead><tr class="text-left">
            <th class="py-2 pr-3">Data</th>
            <th class="py-2 pr-3">Stato</th>
            <th class="py-2 pr-3">Cella</th>
            <th class="py-2 pr-3">Oggetto</th>
            <th class="py-2 pr-3">Temp</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>`);
    const tb = table.querySelector('tbody');
    if (!rows.length){
      tb.appendChild(el(`<tr><td colspan="5" class="py-3 text-slate-500">Nessun evento</td></tr>`));
    } else {
      rows.forEach(r=>{
        const tr = el(`<tr class="border-t hover:bg-slate-50 cursor-pointer" tabindex="0">
          <td class="py-2 pr-3 whitespace-nowrap">${fmtDate(new Date(r.date))}</td>
          <td class="py-2 pr-3">${r.status==='alto'?'<span class="text-rose-700">ALLARME</span>':'<span class="text-emerald-700">OK</span>'}</td>
          <td class="py-2 pr-3">${r.cellKey || statusCellKey(r.subject)}</td>
          <td class="py-2 pr-3">${r.subject}</td>
          <td class="py-2 pr-3">${Number.isFinite(r.temp)? (r.temp.toFixed(1)+'¬∞C') : '‚Äî'}</td>
        </tr>`);
        tr.addEventListener('click', ()=> openRowModal(fid, r));
        tr.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); openRowModal(fid, r);} });
        tb.appendChild(tr);
      });
    }
    wrap.appendChild(table);
  });
}

// MODIFICATO: Bugfix parentesi in exportCsv
function exportCsv(){
  const rowsOut = [['filiale','data','stato','cella','oggetto','temperatura']];  // RIMOSSA PARENTESI EXTRA
  for(const fid of Object.keys(state.history||{})){
    const filObj = (state.filiali||[]).find(x=>x.id===fid);
    const filName = filObj?.name || state.filialeNames[fid] || (state.history[fid]?.[0]?.displayName) || fid;
    (state.history[fid]||[]).forEach(r=>{
      rowsOut.push([filName, new Date(r.date).toISOString(), r.status, r.cellKey||statusCellKey(r.subject), r.subject, Number.isFinite(r.temp)?r.temp.toFixed(2):'']);
    });
  }
  const csv = rowsOut.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  downloadFile('storico.csv', csv, 'text/csv;charset=utf-8;');
}

function printPage(){
  const elDate = $('#printDate'); if (elDate) elDate.textContent = fmtDate(new Date());
  window.print();
}

/* ===================== IMPOSTAZIONI ===================== */
function renderImpostazioni(){
  $('#usernameInput') && ($('#usernameInput').value = state.username || '');
  $('#logoUrlInput') && ($('#logoUrlInput').value = cfg.LOGO_URL || '');
  $('#iconUrlInput') && ($('#iconUrlInput').value = cfg.ICON_URL || '');
  $('#devLogoUrlInput') && ($('#devLogoUrlInput').value = cfg.DEV_LOGO_URL || '');

  const list = $('#filialiList'); if (!list) return;
  list.innerHTML = '';
  (state.filiali||[]).forEach(f=>{
    const card = el(`<div class="glass rounded-xl p-3">
  <div class="grid md:grid-cols-12 gap-3 items-start">
    <label class="block text-sm md:col-span-3">Nome
      <input data-k="name" class="mt-1 w-full bg-white border border-[#E5E7EB] rounded-lg px-3 py-2 focus:ring-2 focus:ring-sky-200" value="${f.name}" />
    </label>
    <label class="block text-sm md:col-span-3">Email storico
      <input data-k="email" class="mt-1 w-full bg-white border border-[#E5E7EB] rounded-lg px-3 py-2 focus:ring-2 focus:ring-sky-200" value="${f.email}" />
    </label>
    <label class="block text-sm md:col-span-2">Provider
      <select data-k="streamProvider" class="mt-1 w-full bg-white border border-[#E5E7EB] rounded-lg px-3 py-2 focus:ring-2 focus:ring-sky-200">
        <option value="jitsi" ${f.streamProvider==='jitsi'?'selected':''}>Jitsi Meet</option>
        <option value="vdo" ${f.streamProvider==='vdo'?'selected':''}>VDO.Ninja</option>
        <option value="whep" ${f.streamProvider==='whep'?'selected':''}>WHEP/Worker</option>
      </select>
    </label>

    <div data-group="jitsi" class="md:col-span-4" style="${f.streamProvider==='jitsi'?'':'display:none'}">
      <label class="block text-sm">Jitsi domain
        <input data-k="jitsiDomain" class="mt-1 w-full bg-white border border-[#E5E7EB] rounded-lg px-3 py-2 focus:ring-2 focus:ring-sky-200" value="${f.jitsiDomain||'meet.jit.si'}" />
      </label>
      <label class="block text-sm">Room
        <input data-k="jitsiRoom" class="mt-1 w-full bg-white border border-[#E5E7EB] rounded-lg px-3 py-2 focus:ring-2 focus:ring-sky-200" value="${f.jitsiRoom||''}" />
      </label>
      <label class="block text-sm">Password (visibile)
        <input data-k="jitsiPass" class="mt-1 w-full bg-white border border-[#E5E7EB] rounded-lg px-3 py-2 focus:ring-2 focus:ring-sky-200" value="${f.jitsiPass||''}" />
      </label>
    </div>

    <div data-group="vdo" class="md:col-span-3" style="${f.streamProvider==='vdo'?'':'display:none'}">
      <label class="block text-sm">VDO View ID
        <input data-k="vdoViewId" class="mt-1 w-full bg-white border border-[#E5E7EB] rounded-lg px-3 py-2 focus:ring-2 focus:ring-sky-200" value="${f.vdoViewId||''}" />
      </label>
      <label class="block text-sm">VDO Password
        <input data-k="vdoPassword" class="mt-1 w-full bg-white border border-[#E5E7EB] rounded-lg px-3 py-2 focus:ring-2 focus:ring-sky-200" value="${f.vdoPassword||''}" />
      </label>
    </div>

    <div data-group="whep" class="md:col-span-4" style="${f.streamProvider==='whep'?'':'display:none'}">
      <label class="block text-sm">URL WHEP (HTTPS)
        <input data-k="streamUrl" class="mt-1 w-full bg-white border border-[#E5E7EB] rounded-lg px-3 py-2 focus:ring-2 focus:ring-sky-200" value="${f.streamUrl||''}" />
      </label>
      <label class="block text-sm">ID
        <input data-k="streamUser" class="mt-1 w-full bg-white border border-[#E5E7EB] rounded-lg px-3 py-2 focus:ring-2 focus:ring-sky-200" value="${f.streamUser||''}" />
      </label>
      <label class="block text-sm">Password
        <input data-k="streamPass" class="mt-1 w-full bg-white border border-[#E5E7EB] rounded-lg px-3 py-2 focus:ring-2 focus:ring-sky-200" value="${f.streamPass||''}" />
      </label>
      <label class="flex items-center gap-2 text-sm mt-2">
        <input type="checkbox" data-k="streamAudio" ${f.streamAudio?'checked':''} class="accent-emerald-500"> Audio (se supportato)
      </label>
    </div>

    <div class="md:col-span-12 flex flex-wrap gap-2 justify-between mt-1">
      <div class="flex gap-2">
        <button data-act="open" class="btn">Apri live</button>
        <button data-act="provider" class="btn btn-primary">Apri su Provider</button>
      </div>
      <div class="flex gap-2">
        <button data-act="save" class="btn btn-positive">Salva</button>
        <button data-act="del" class="btn btn-negative">Elimina</button>
      </div>
    </div>
  </div>
</div>`);

    card.querySelector('[data-k="streamProvider"]')?.addEventListener('change', (e)=>{
      const v = e.target.value;
      card.querySelector('[data-group="jitsi"]').style.display = v==='jitsi' ? '' : 'none';
      card.querySelector('[data-group="vdo"]').style.display   = v==='vdo'   ? '' : 'none';
      card.querySelector('[data-group="whep"]').style.display  = v==='whep'  ? '' : 'none';
    });
    card.querySelector('[data-act="save"]')?.addEventListener('click', ()=>{
      card.querySelectorAll('[data-k]').forEach(inp=>{
        const k = inp.dataset.k;
        if (inp.type==='checkbox') f[k] = inp.checked;
        else f[k] = inp.value;
      });
      state.filialeNames[f.id] = f.name; // aggiorna mapping
      saveState(); populateFilialeSelect(); refreshUIAfterData();
      alert('Salvato.');
    });
    card.querySelector('[data-act="del"]')?.addEventListener('click', ()=>{
      if(!confirm('Eliminare la filiale?')) return;
      state.history[f.id] = [];
      delete state.filialeNames[f.id];
      state.filiali = (state.filiali||[]).filter(x=>x.id!==f.id);
      saveState(); renderImpostazioni(); populateFilialeSelect(); refreshUIAfterData();
    });
    card.querySelector('[data-act="open"]')?.addEventListener('click', ()=>{
      const sel = $('#filialeSelect'); if (sel){ sel.value = f.id; startLiveForCurrent(); go('home'); }
    });
    card.querySelector('[data-act="provider"]')?.addEventListener('click', ()=> openOnProvider(f));
    list.appendChild(card);
  });
}

/* ===================== BRANDING ===================== */
function applyBranding(){
  const logoBox = $('#brandLogoBox');
  const logoImg = $('#brandLogoImg');
  if (cfg.LOGO_URL) {
    if (logoImg){ logoImg.src = cfg.LOGO_URL; logoImg.classList.remove('hidden'); }
    logoBox?.classList.remove('brand-grad');
  } else {
    logoImg?.classList.add('hidden'); logoImg?.removeAttribute?.('src'); logoBox?.classList.add('brand-grad');
  }
  const fav = $('#dynamic-favicon'); if (fav && cfg.ICON_URL){ fav.href = cfg.ICON_URL; }
  const sidebarSiteLogo = $('#sidebarSiteLogo'); if (sidebarSiteLogo) sidebarSiteLogo.src = cfg.LOGO_URL || '';
  const sidebarDevLogo = $('#sidebarDevLogo'); if (sidebarDevLogo) sidebarDevLogo.src = cfg.DEV_LOGO_URL || '';
}

/* ===================== GLOBAL REFRESH ===================== */
function refreshUIAfterData(){
  checkFilialiStatus();
  runCheckFiliali();
  uiRenderFilialiDesc();
  renderHomeStats24h();
  if(location.hash==='#storico') renderStorico();
  const totalEvents = Object.values(state.history||{}).reduce((acc, arr)=> acc + (arr?.length||0), 0);
  if ($('#quickStats') && totalEvents) $('#quickStats').textContent = `Eventi totali: ${totalEvents}`;
}

/* ===================== BOOT ORDINATO ===================== */
window.addEventListener('DOMContentLoaded', async ()=>{

  // Stato + select
  loadState();
  populateFilialeSelect();

  // PATCH preload login
  const b1 = $('#btnSignIn'), b2 = $('#btnChangeAccount');
  b1?.setAttribute('disabled','');
  b2?.setAttribute('disabled','');

  try { await initGapi(); } catch(e){ console.warn('initGapi fallita', e); }
  try { await initGIS(); }  catch(e){ console.warn('initGIS fallita', e); }

  if (tokenClient) {
    b1?.removeAttribute('disabled');
    b2?.removeAttribute('disabled');
  } else {
    console.warn('GIS non pronto: lascio disabilitati i bottoni finch√© non carica.');
  }

  // Router
  document.querySelectorAll('.tab-btn').forEach(b=> b.addEventListener('click', ()=> go(b.dataset.route.slice(1))));
  const initial = (location.hash || '#home'); setActiveTab(initial); go((initial||'#home').slice(1));

  // Filiale default e cambi
  if (state.filiali[0] && $('#filialeSelect')) $('#filialeSelect').value = state.filiali[0].id;
  $('#filialeSelect')?.addEventListener('change', ()=> startLiveForCurrent());

  // LIVE controls
  uiBindLiveSizer();
  $('#btnReconnect')?.addEventListener('click', ()=> startLiveForCurrent());
  $('#btnOpenProvider')?.addEventListener('click', ()=>{
    const f = (state.filiali||[]).find(x=>x.id === $('#filialeSelect')?.value);
    if(!f) return; openOnProvider(f);
  });
  $('#btnCopySid')?.addEventListener('click', ()=>{
    const f=(state.filiali||[]).find(x=>x.id===$('#filialeSelect')?.value); if(!f) return;
    const id = (f.streamProvider==='jitsi')?f.jitsiRoom:(f.streamProvider==='vdo'?f.vdoViewId:f.streamUser); copyTxt(id||'');
  });
  $('#btnCopyPwd')?.addEventListener('click', ()=>{
    const f=(state.filiali||[]).find(x=>x.id===$('#filialeSelect')?.value); if(!f) return;
    const pw = (f.streamProvider==='jitsi')?f.jitsiPass:(f.streamProvider==='vdo'?f.vdoPassword:f.streamPass); copyTxt(pw||'');
  });

  // Profilo & Branding
  $('#usernameInput')?.addEventListener('change', (e)=>{ state.username=e.target.value; saveState() });
  $('#btnSaveBranding')?.addEventListener('click', ()=>{ cfg.LOGO_URL=$('#logoUrlInput')?.value.trim()||''; cfg.ICON_URL=$('#iconUrlInput')?.value.trim()||''; cfg.DEV_LOGO_URL=$('#devLogoUrlInput')?.value.trim()||''; saveState(); applyBranding(); alert('Loghi salvati.'); });

  // Aggiungi filiale
  $('#btnAddFiliale')?.addEventListener('click', ()=>{
    const idNew = (crypto?.randomUUID?.() || ('f'+Date.now()));
    const nf = { id: idNew, name: 'Nuova filiale', email: 'allarmi@edilrepairs.ch', streamProvider: 'jitsi', jitsiDomain: 'meet.jit.si', jitsiRoom: '', jitsiPass: '', vdoViewId: '', vdoPassword: '', streamUrl: '', streamUser: '', streamPass: '', streamAudio: false };
    state.filiali.push(nf);
    state.filialeNames[idNew] = nf.name;
    saveState(); renderImpostazioni(); populateFilialeSelect();
  });

  // Advanced modal
  function openAdvancedModal() {
    const modal = $('#advModal'); const gate = $('#advGate'); const body = $('#advBody');
    if (!modal || !gate || !body) return;
    modal.classList.add('show'); gate.classList.remove('hidden'); body.classList.add('hidden');
    const host = location.host; $('#originsHint') && ($('#originsHint').textContent = `https://${host}`);
    $('#advClientId') && ($('#advClientId').value = cfg?.CLIENT_ID || '');
    $('#advApiKey') && ($('#advApiKey').value = cfg?.API_KEY || '');
    $('#advGmailQuery') && ($('#advGmailQuery').value = cfg?.GMAIL_QUERY || '');
    $('#advTempRx') && ($('#advTempRx').value = cfg?.TEMP_RX || '');
    $('#advLoginHint') && ($('#advLoginHint').value = cfg?.LOGIN_HINT || '');
    $('#advScopes') && ($('#advScopes').value = cfg?.SCOPES || DEFAULTS.SCOPES || '');
    setTimeout(()=>{ $('#advPwd')?.focus(); }, 100);
  }
  window.openAdvancedModal = openAdvancedModal;
  $('#btnAdvanced')?.addEventListener('click', ()=> openAdvancedModal());
  $('#advClose') && ($('#advClose').onclick = ()=> $('#advModal')?.classList.remove('show'));
  $('#advUnlock') && ($('#advUnlock').onclick = ()=>{ if($('#advPwd')?.value==='979851'){ $('#advGate')?.classList.add('hidden'); $('#advBody')?.classList.remove('hidden'); setTimeout(()=>$('#advClientId')?.focus(),100); } else { alert('Password errata'); } });
  $('#advSave') && ($('#advSave').onclick = ()=>{
    cfg.CLIENT_ID  = $('#advClientId')?.value.trim() || '';
    cfg.API_KEY    = $('#advApiKey')?.value.trim() || '';
    cfg.GMAIL_QUERY= $('#advGmailQuery')?.value.trim() || '';
    cfg.TEMP_RX    = $('#advTempRx')?.value.trim() || '';
    cfg.LOGIN_HINT = $('#advLoginHint')?.value.trim() || '';
    cfg.SCOPES     = $('#advScopes')?.value.trim() || DEFAULTS.SCOPES;
    saveState();
    (async ()=>{
      try{ await initGapi(); try{ initGIS(); }catch{} alert('Impostazioni salvate.'); }catch(e){ alert('Errore init: ' + (e?.message || e)); }
    })();
    $('#advModal')?.classList.remove('show');
  });
  $('#advTest') && ($('#advTest').onclick = async ()=>{
    try{ await signOut(); await signIn('consent'); await fetchAlarms(); alert('Accesso OK, storico aggiornato.'); } catch(e){ alert('Errore test accesso: ' + (e?.message || e)); }
  });
  $('#advReset') && ($('#advReset').onclick = ()=>{ localStorage.removeItem('resinelli_monitor'); location.reload(); });

  // Report global
  $('#btnReportGlobal')?.addEventListener('click', ()=> openAIReport(null, null));
  // Chiudi report
  $('#aiReportClose') && ($('#aiReportClose').onclick = ()=> $('#aiReportModal')?.classList.remove('show'));
  $('#aiReportModal')?.addEventListener('click', (e)=>{ if (e.target===e.currentTarget) e.currentTarget.classList.remove('show'); });

  // Filtri storico + export + stampa + controlli
  document.querySelectorAll('.range-btn').forEach(b=>{
    b.addEventListener('click', ()=>{
      currentRange = b.dataset.range || 'all';
      renderStorico();
    });
  });
  $('#btnExportCsv')?.addEventListener('click', exportCsv);
  $('#btnPrint')?.addEventListener('click', printPage);
  applyHistControlsHandlers();

  // Aggiorna manuale (sidebar)
  $('#btnRefresh')?.addEventListener('click', gmailTick);

  /* Boot order garantito:
     initGapi() ‚Üí initGIS() ‚Üí silent sign-in/restore ‚Üí fetchAlarms() ‚Üí startLiveForCurrent() ‚Üí startGmailPolling()
  */
  try { await initGapi(); } catch (e) { console.warn('initGapi fallita', e); }
  try { await initGIS(); }  catch (e) { console.warn('initGIS fallita', e); }

  try{
    if (isTokenValid()){
      window.gapi?.client?.setToken?.({ access_token: state.oauth.access_token });
    }
    await ensureToken();
  }catch(e){ /* ignora */ }

  try{
    if (gmailService.isConnected()) { await fetchAlarms(); }
  } catch(e){ console.warn('fetchAlarms iniziale fallita', e); }

  try { await startLiveForCurrent(); } catch (e) { console.warn('startLiveForCurrent fallita', e); }
  try { startGmailPolling(); } catch (e) { console.warn('startGmailPolling fallita', e); }
  startTokenAutoRefresh();
  updateGmailStatusUI();

  // Signin/change account (PATCH: robust async handler)
  async function openGmailChooserInline(){
    try{
      if (!tokenClient) await initGIS();            // garantisce il client
      tokenClient.callback = async (resp)=>{
        if (resp?.access_token){
          window.gapi?.client?.setToken?.({ access_token: resp.access_token });
          setAccessTokenFromResp(resp);
          try { await fetchAlarms(); } catch(_) {}
          updateGmailStatusUI();
        }
      };
      tokenClient.requestAccessToken({
        prompt: 'select_account',
        hint: cfg.LOGIN_HINT || ''
      });
    }catch(e){
      alert('Login non disponibile: ' + (e?.message || e));
    }
  }
  $('#btnSignIn')?.addEventListener('click', openGmailChooserInline);
  $('#btnChangeAccount')?.addEventListener('click', openGmailChooserInline);

  // Modal riga: chiudi clic overlay
  $('#rowModal')?.addEventListener('click', (e)=>{ if (e.target===e.currentTarget) e.currentTarget.classList.remove('show'); });

  // Cleanup
  window.addEventListener('beforeunload', ()=>{ stopWhepResource(); cleanupWebRTC(); destroyJitsi(); stopGmailPolling(); });
  window.addEventListener('focus', gmailTick);
});
</script>
</body>
</html>